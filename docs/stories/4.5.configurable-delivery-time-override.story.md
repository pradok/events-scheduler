# Story 4.5: Configurable Delivery Time Override for Manual Testing

**Epic:** [Epic 4 - End-to-End Testing & Manual Testing Infrastructure](../prd/epic-4-end-to-end-testing.md)
**Status:** In Progress ðŸ”„
**Priority:** High
**Estimated Effort:** 3 hours
**Agent Model Used:** Claude Sonnet 4.5

---

## Story

**As a** developer/QA tester,
**I want** a domain-pure configuration system with environment variable override support,
**so that** I can manually test the E2E event flow with fast triggers (e.g., 5 minutes) instead of waiting until the default delivery time (9am), while maintaining clean architecture and enabling future multi-event-type scenarios.

---

## Business Context

**Current Challenge:**
- Birthday events are hardcoded to trigger at 9:00 AM local time
- Manual E2E testing requires either:
  - Waiting until 9am (impractical)
  - Manually hacking the database to change event timestamps (fragile, error-prone)
  - Creating artificial "overdue" events (doesn't test real-time flow)

**Desired Outcome:**
- Start API server with override: `EVENT_DELIVERY_OVERRIDE=+5 npm run dev`
- Create user via API
- Birthday event automatically scheduled for 5 minutes from now
- Test complete flow: scheduler claims event â†’ worker executes â†’ webhook delivered

**Future Extensibility:**
- Simple global override (this story)
- Per-event-type rules (future)
- Per-user custom delivery times (future)
- Database-driven delivery time rules (future)
- Multiple events per user (birthdays, anniversaries, reminders)

---

## Future Extensibility & Gap Analysis

### Current System (Story Scope)

**Single Event Per User:**
- Current: One birthday event auto-created when user is created
- EventType: Hardcoded to `'BIRTHDAY'`
- Configuration: Global override applies to ALL events uniformly

**What This Story Enables:**
- âœ… Fast manual testing (5-minute triggers)
- âœ… Clean architecture (port/adapter pattern)
- âœ… Easy to swap config providers
- âœ… Foundation for per-event-type configuration

### Future Scenarios (Out of Scope - Document Only)

#### Scenario 1: Multiple Event Types Per User

**Use Case:** User wants birthday reminder + anniversary reminder + custom reminder

**Current Limitations:**
- `CreateBirthdayEventOnUserCreatedHandler` creates only birthday events
- No mechanism to create multiple event types on user creation
- `IDeliveryTimeConfigProvider.getConfig()` accepts `eventType` parameter but only `'BIRTHDAY'` is used

**Future Design (Migration Path):**

```typescript
// Phase 1 (This Story): Global override for ALL events
EVENT_DELIVERY_OVERRIDE=+5 npm run dev
// Both birthday and anniversary trigger in 5 minutes

// Phase 2 (Future): Per-event-type override
EVENT_DELIVERY_RULES='{"BIRTHDAY":"+5","ANNIVERSARY":"+10"}'
// Birthday: 5 min, Anniversary: 10 min

// Phase 3 (Future): Database-driven per-user
SELECT delivery_hour, delivery_minute
FROM user_event_preferences
WHERE user_id=? AND event_type=?
```

**Changes Needed (Future Story):**
1. Create `CreateAnniversaryEventOnUserCreatedHandler`
2. Add `anniversaryDate` field to User model
3. Extend `IDeliveryTimeConfigProvider.getConfig()` to handle `'ANNIVERSARY'`
4. Update EventBusFactory to register both handlers

**Our Design Already Supports This:**
- âœ… `IDeliveryTimeConfigProvider.getConfig(eventType)` accepts event type
- âœ… Providers can return different configs per event type
- âœ… No code changes needed to domain layer

#### Scenario 2: Manual Event Creation (Not Auto-Generated)

**Use Case:** User creates a custom reminder event via API (not auto-generated on user creation)

**Current Behavior:**
- Birthday events ONLY created when user is created (domain event: `UserCreated`)
- No API endpoint for manual event creation

**Future Design:**
```typescript
POST /user/:userId/events
{
  "eventType": "REMINDER",
  "message": "Call dentist",
  "targetDate": "2025-11-15",
  "deliveryTime": "14:00" // Optional override
}
```

**Changes Needed (Future Story):**
1. Create `CreateEventUseCase` (generic, not birthday-specific)
2. Add REST endpoint: `POST /user/:userId/events`
3. Support optional `deliveryTime` in request
4. Extend config provider to support per-request overrides

**Our Design Already Supports This:**
- âœ… `BirthdayEventHandler` is just one strategy implementation
- âœ… Can create `ReminderEventHandler`, `AnniversaryEventHandler`, etc.
- âœ… Config provider pattern allows per-request configuration

#### Scenario 3: Per-User Custom Delivery Times

**Use Case:** User A wants birthday reminders at 8am, User B wants them at 10am

**Current Behavior:**
- Global delivery time for all users (9am or override)
- No per-user customization

**Future Design (Database-Driven):**
```sql
CREATE TABLE user_event_preferences (
  user_id UUID,
  event_type VARCHAR(50),
  delivery_hour INT,
  delivery_minute INT,
  PRIMARY KEY (user_id, event_type)
);
```

```typescript
// New provider implementation
class DatabaseDeliveryTimeConfigProvider implements IDeliveryTimeConfigProvider {
  async getConfig(eventType: 'BIRTHDAY', userId?: string): EventDeliveryTimeConfig {
    if (userId) {
      const pref = await db.getUserEventPreference(userId, eventType);
      if (pref) return { hour: pref.delivery_hour, minute: pref.delivery_minute };
    }
    return this.defaultProvider.getConfig(eventType);
  }
}
```

**Changes Needed (Future Story):**
1. Add `user_event_preferences` table
2. Extend `IDeliveryTimeConfigProvider.getConfig()` to accept optional `userId`
3. Create `DatabaseDeliveryTimeConfigProvider`
4. Update `CreateBirthdayEventUseCase` to pass `userId` to config provider

**Our Design Migration Path:**
- âœ… Interface can be extended without breaking existing code
- âœ… Decorator pattern allows wrapping database provider
- âœ… Fallback to default if no user preference exists

### Identified Gaps (Not Blocking This Story)

| Gap | Impact | When Needed | Migration Effort |
|-----|--------|-------------|------------------|
| No multi-event-type creation on user signup | Can't create birthday + anniversary together | When adding anniversary feature | Medium - Need new handler |
| No API for manual event creation | Can only create events via user creation | When adding custom reminders | Medium - New REST endpoint |
| No per-user delivery time preferences | All users get same delivery time | When users want customization | High - Database migration |
| Config provider not async | Can't fetch from database | When adding DB-driven config | Medium - Update interface |
| No event-type validation | Could pass invalid event type to config | When adding new event types | Low - Add enum/validation |

### Design Decisions for This Story

**âœ… Decisions That Enable Future Extension:**
1. **Port/Adapter Pattern**: Config provider is swappable
2. **Event Type Parameter**: `getConfig(eventType)` already accepts type
3. **Decorator Pattern**: Easy to chain providers (env â†’ DB â†’ default)
4. **No Hardcoding**: All event types referenced via constants/enums

**âš ï¸ Deliberate Limitations (Future Stories Will Address):**
1. **Synchronous Config**: Provider is sync (future: async for DB)
2. **No User Context**: Provider doesn't know userId (future: pass userId)
3. **Global Override**: Applies to ALL events uniformly (future: per-type)
4. **Single Event Creation**: UserCreated handler creates only birthday (future: multiple handlers)

### Recommendation

**For This Story:**
- âœ… Implement as designed (port/adapter pattern)
- âœ… Keep interface simple (sync, no userId)
- âœ… Document future extension points
- âœ… Add TODO comments in code for future enhancements

**For Future Stories:**
- Create "Story 5.X: Multiple Event Types Per User" when anniversary feature needed
- Create "Story 6.X: Per-User Delivery Time Preferences" when customization needed
- Create "Story 7.X: Manual Event Creation API" when ad-hoc events needed

---

## Acceptance Criteria

### âœ… AC1: Environment Variable Override
- **Given** `EVENT_DELIVERY_OVERRIDE` env var is NOT set
- **When** a birthday event is created
- **Then** event uses default delivery time (9:00 AM local time)

- **Given** `EVENT_DELIVERY_OVERRIDE=+5` env var is set
- **When** a birthday event is created
- **Then** event is scheduled for 5 minutes from current time

### âœ… AC2: Format Validation
- **Given** `EVENT_DELIVERY_OVERRIDE=+5` (valid format)
- **Then** system accepts and uses 5-minute offset

- **Given** `EVENT_DELIVERY_OVERRIDE=invalid` (invalid format)
- **Then** system throws clear error on startup with expected format

- **Given** `EVENT_DELIVERY_OVERRIDE=+0` (invalid value)
- **Then** system throws error (must be >= 1 minute)

- **Given** `EVENT_DELIVERY_OVERRIDE=+1500` (> 24 hours)
- **Then** system throws error (must be <= 1440 minutes)

### âœ… AC3: Works Across All Entry Points
- Override works when creating events via:
  - User API (POST /user)
  - Event handlers (UserCreated domain event)
  - Lambda functions (if applicable)

### âœ… AC4: Logging and Observability
- **Given** override is active
- **When** application starts
- **Then** log clearly indicates override is active:
  ```
  INFO: EVENT_DELIVERY_OVERRIDE active: +5 (events will trigger 5 minutes from creation)
  ```

- **Given** override is NOT active
- **When** application starts
- **Then** log indicates production mode:
  ```
  INFO: Using default delivery times (9:00 AM for birthdays)
  ```

### âœ… AC5: Manual Test Script
- NPM script: `npm run test:manual` or `npm run test:manual:fast`
- Script sets `EVENT_DELIVERY_OVERRIDE=+5`
- Creates test user via API
- Displays instructions for monitoring event execution
- Shows expected trigger time

### âœ… AC6: Documentation
- README updated with manual testing instructions
- Environment variable documented in [local-development.md](../local-development.md)
- Example commands provided

---

## Technical Design

### Architecture - Hexagonal / Clean Architecture Approach

**Design Principle:** Keep domain pure, isolate infrastructure concerns via ports and adapters.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    INFRASTRUCTURE LAYER                      â”‚
â”‚                   (Outer Hexagon)                            â”‚
â”‚                                                              â”‚
â”‚  EnvironmentDeliveryTimeConfigProvider                      â”‚
â”‚  - Reads ENV var: EVENT_DELIVERY_OVERRIDE                   â”‚
â”‚  - Parses "+5" â†’ 5 minutes offset                           â”‚
â”‚  - Implements: IDeliveryTimeConfigProvider                  â”‚
â”‚  - Only place that touches process.env                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ implements
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   APPLICATION LAYER                          â”‚
â”‚                   (Inner Hexagon)                            â”‚
â”‚                                                              â”‚
â”‚  IDeliveryTimeConfigProvider (PORT - Interface)             â”‚
â”‚  - getConfig(eventType): EventDeliveryTimeConfig            â”‚
â”‚  - isOverrideActive(): boolean                              â”‚
â”‚                                                              â”‚
â”‚  EventBusFactory (MODIFIED)                                 â”‚
â”‚  - Receives IDeliveryTimeConfigProvider via DI              â”‚
â”‚  - Calls: provider.getConfig('BIRTHDAY')                    â”‚
â”‚  - Creates: new BirthdayEventHandler(config)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ provides config to
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DOMAIN LAYER                            â”‚
â”‚                   (Pure Business Logic)                      â”‚
â”‚                                                              â”‚
â”‚  BirthdayEventHandler (NO CHANGES)                          â”‚
â”‚  - Receives pure EventDeliveryTimeConfig { hour, minute }   â”‚
â”‚  - NO knowledge of env vars or infrastructure               â”‚
â”‚  - calculateNextOccurrence() uses config.hour & minute      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Dependency Flow (Hexagonal Architecture)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Startup / Composition Root (main.ts / server-standalone.ts)â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  const defaultProvider = new StaticDeliveryTimeConfigProvider();
â”‚  const configProvider = new EnvironmentDeliveryTimeConfigProvider(
â”‚    defaultProvider
â”‚  );
â”‚  const eventBus = createEventBus(prisma, configProvider);   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                           â”‚
         â”‚ injects                   â”‚ injects
         â–¼                           â–¼
   Application Layer           Infrastructure Layer
   (uses interface)           (implements interface)
```

### Files to Create

```
src/modules/event-scheduling/
â”œâ”€â”€ application/
â”‚   â””â”€â”€ ports/
â”‚       â””â”€â”€ IDeliveryTimeConfigProvider.ts (NEW - Port/Interface)
â”‚           - IDeliveryTimeConfigProvider interface
â”‚           - getConfig(eventType)
â”‚           - isOverrideActive()
â”‚
â”œâ”€â”€ config/
â”‚   â””â”€â”€ StaticDeliveryTimeConfigProvider.ts (NEW - Default Implementation)
â”‚       - Returns hardcoded EVENT_DELIVERY_TIMES
â”‚       - Production default (9am)
â”‚       - No external dependencies
â”‚
â””â”€â”€ adapters/
    â””â”€â”€ config/
        â””â”€â”€ EnvironmentDeliveryTimeConfigProvider.ts (NEW - Env Adapter)
            - Reads EVENT_DELIVERY_OVERRIDE env var
            - Parses "+5" format
            - Validates offset (1-1440 minutes)
            - Delegates to default if no override
            - ONLY place that touches process.env

scripts/
â””â”€â”€ test-manual-e2e.sh (NEW)
    - Sets EVENT_DELIVERY_OVERRIDE=+5
    - Starts API server
    - Creates test user
    - Shows monitoring commands
```

### Files to Modify

```
src/shared/events/EventBusFactory.ts
- Add configProvider parameter: IDeliveryTimeConfigProvider
- Call: configProvider.getConfig('BIRTHDAY')
- Pass config to BirthdayEventHandler constructor
- Signature: createEventBus(prisma, configProvider)

src/server-standalone.ts (or src/index.ts)
- Instantiate StaticDeliveryTimeConfigProvider
- Wrap with EnvironmentDeliveryTimeConfigProvider
- Pass to createEventBus()
- Log override status on startup

src/adapters/primary/lambda/schedulerHandler.ts
- Instantiate config provider
- Pass to event bus factory

src/adapters/primary/lambda/workerHandler.ts
- Instantiate config provider
- Pass to event bus factory
```

### Implementation Details

**IDeliveryTimeConfigProvider.ts (Port/Interface):**
```typescript
// src/modules/event-scheduling/application/ports/IDeliveryTimeConfigProvider.ts
import { EventDeliveryTimeConfig } from '../../config/event-delivery-times';

/**
 * Port for delivery time configuration
 *
 * Allows different implementations:
 * - StaticDeliveryTimeConfigProvider (hardcoded 9am)
 * - EnvironmentDeliveryTimeConfigProvider (env var override)
 * - DatabaseDeliveryTimeConfigProvider (future: DB-driven)
 */
export interface IDeliveryTimeConfigProvider {
  /**
   * Get delivery time config for an event type
   * Domain-pure: No knowledge of where config comes from
   */
  getConfig(eventType: 'BIRTHDAY' | 'ANNIVERSARY'): EventDeliveryTimeConfig;

  /**
   * Check if override/custom config is active (for logging)
   */
  isOverrideActive(): boolean;
}
```

**StaticDeliveryTimeConfigProvider.ts (Default Implementation):**
```typescript
// src/modules/event-scheduling/config/StaticDeliveryTimeConfigProvider.ts
import { IDeliveryTimeConfigProvider } from '../application/ports/IDeliveryTimeConfigProvider';
import { EventDeliveryTimeConfig, EVENT_DELIVERY_TIMES } from './event-delivery-times';

/**
 * Default delivery time config provider
 * Returns hardcoded delivery times (9am for birthdays)
 * Used in production
 */
export class StaticDeliveryTimeConfigProvider implements IDeliveryTimeConfigProvider {
  public getConfig(eventType: 'BIRTHDAY'): EventDeliveryTimeConfig {
    return EVENT_DELIVERY_TIMES[eventType];
  }

  public isOverrideActive(): boolean {
    return false; // Static config = no override
  }
}
```

**EnvironmentDeliveryTimeConfigProvider.ts (Env Var Adapter):**
```typescript
// src/modules/event-scheduling/adapters/config/EnvironmentDeliveryTimeConfigProvider.ts
import { DateTime } from 'luxon';
import { IDeliveryTimeConfigProvider } from '../../application/ports/IDeliveryTimeConfigProvider';
import { EventDeliveryTimeConfig } from '../../config/event-delivery-times';

/**
 * Environment-based delivery time config provider
 * Reads EVENT_DELIVERY_OVERRIDE env var, falls back to default provider
 * Used for manual testing with fast triggers
 */
export class EnvironmentDeliveryTimeConfigProvider implements IDeliveryTimeConfigProvider {
  constructor(
    private readonly defaultProvider: IDeliveryTimeConfigProvider,
    private readonly envVarName: string = 'EVENT_DELIVERY_OVERRIDE'
  ) {}

  public getConfig(eventType: 'BIRTHDAY'): EventDeliveryTimeConfig {
    const override = process.env[this.envVarName]; // Only infra concern

    if (!override) {
      return this.defaultProvider.getConfig(eventType); // Delegate
    }

    const offsetMinutes = this.parseOverride(override);
    const targetTime = DateTime.now().plus({ minutes: offsetMinutes });

    return {
      hour: targetTime.hour,
      minute: targetTime.minute,
    };
  }

  public isOverrideActive(): boolean {
    return !!process.env[this.envVarName];
  }

  private parseOverride(override: string): number {
    const match = override.match(/^\+(\d+)$/);
    if (!match) {
      throw new Error(
        `Invalid EVENT_DELIVERY_OVERRIDE: "${override}". Expected: "+{minutes}"`
      );
    }

    const offsetMinutes = parseInt(match[1]!, 10);
    if (offsetMinutes < 1 || offsetMinutes > 1440) {
      throw new Error(
        `Invalid offset: ${offsetMinutes}. Must be 1-1440 minutes`
      );
    }

    return offsetMinutes;
  }
}
```

**EventBusFactory.ts modification:**
```typescript
// src/shared/events/EventBusFactory.ts
import { IDeliveryTimeConfigProvider } from '../../modules/event-scheduling/application/ports/IDeliveryTimeConfigProvider';

export function createEventBus(
  prisma: PrismaClient,
  configProvider: IDeliveryTimeConfigProvider // Injected dependency
): InMemoryEventBus {
  const eventBus = new InMemoryEventBus();

  // Shared dependencies
  const eventRepository = new PrismaEventRepository(prisma);
  const timezoneService = new TimezoneService();
  const eventHandlerRegistry = new EventHandlerRegistry();

  // Get config from provider (no knowledge of source)
  const birthdayConfig = configProvider.getConfig('BIRTHDAY');
  eventHandlerRegistry.register(new BirthdayEventHandler(birthdayConfig));

  // ... rest of factory
}
```

**Composition Root (server-standalone.ts):**
```typescript
// src/server-standalone.ts
import { StaticDeliveryTimeConfigProvider } from './modules/event-scheduling/config/StaticDeliveryTimeConfigProvider';
import { EnvironmentDeliveryTimeConfigProvider } from './modules/event-scheduling/adapters/config/EnvironmentDeliveryTimeConfigProvider';

// Dependency injection at startup
const defaultProvider = new StaticDeliveryTimeConfigProvider();
const configProvider = new EnvironmentDeliveryTimeConfigProvider(defaultProvider);

// Log override status
if (configProvider.isOverrideActive()) {
  logger.warn({
    msg: 'EVENT_DELIVERY_OVERRIDE active - events will trigger with custom timing',
    override: process.env.EVENT_DELIVERY_OVERRIDE
  });
} else {
  logger.info('Using default delivery times (9:00 AM for birthdays)');
}

const eventBus = createEventBus(prisma, configProvider);
```

**Manual test script (test-manual-e2e.sh):**
```bash
#!/bin/bash
export EVENT_DELIVERY_OVERRIDE=+5
npm run dev &
SERVER_PID=$!

echo "Creating test user..."
curl -X POST http://localhost:3000/user \
  -H "Content-Type: application/json" \
  -d '{
    "firstName": "Test",
    "lastName": "User",
    "dateOfBirth": "1990-10-27",
    "timezone": "Australia/Sydney",
    "email": "test@example.com"
  }'

echo "Event will trigger in 5 minutes. Monitor with:"
echo "  docker logs -f localstack-main"
echo "  npm run prisma:studio"
```

---

## Tasks

### Task 1: Create Port (Interface)
- [ ] Create `src/modules/event-scheduling/application/ports/IDeliveryTimeConfigProvider.ts`
- [ ] Define `IDeliveryTimeConfigProvider` interface
- [ ] Method: `getConfig(eventType): EventDeliveryTimeConfig`
- [ ] Method: `isOverrideActive(): boolean`
- [ ] Add comprehensive JSDoc comments

### Task 2: Create Static Provider (Default Implementation)
- [ ] Create `src/modules/event-scheduling/config/StaticDeliveryTimeConfigProvider.ts`
- [ ] Implement `IDeliveryTimeConfigProvider`
- [ ] Return `EVENT_DELIVERY_TIMES[eventType]` in `getConfig()`
- [ ] Return `false` in `isOverrideActive()`
- [ ] Add unit tests

### Task 3: Create Environment Provider (Adapter)
- [ ] Create `src/modules/event-scheduling/adapters/config/` directory
- [ ] Create `EnvironmentDeliveryTimeConfigProvider.ts`
- [ ] Implement `IDeliveryTimeConfigProvider`
- [ ] Constructor accepts `defaultProvider` (decorator pattern)
- [ ] Read `EVENT_DELIVERY_OVERRIDE` env var
- [ ] Implement `parseOverride()` private method
- [ ] Validate format: `+{minutes}`
- [ ] Validate range: 1-1440 minutes
- [ ] Calculate dynamic time: `DateTime.now().plus({ minutes })`
- [ ] Add unit tests

### Task 4: Modify EventBusFactory
- [ ] Add `configProvider: IDeliveryTimeConfigProvider` parameter
- [ ] Call `configProvider.getConfig('BIRTHDAY')`
- [ ] Pass config to `BirthdayEventHandler` constructor
- [ ] Update function signature
- [ ] Ensure no breaking changes to existing callers

### Task 5: Update Composition Roots
- [ ] Modify `src/server-standalone.ts`
  - [ ] Instantiate `StaticDeliveryTimeConfigProvider`
  - [ ] Wrap with `EnvironmentDeliveryTimeConfigProvider`
  - [ ] Pass to `createEventBus()`
  - [ ] Add startup logging
- [ ] Modify `src/adapters/primary/lambda/schedulerHandler.ts`
  - [ ] Same provider setup
- [ ] Modify `src/adapters/primary/lambda/workerHandler.ts`
  - [ ] Same provider setup

### Task 6: Add Startup Logging
- [ ] Log override status when application starts
- [ ] Show active override value if set
- [ ] Show production mode if not set

### Task 4: Create Manual Test Script
- [ ] Create `scripts/test-manual-e2e.sh`
- [ ] Set `EVENT_DELIVERY_OVERRIDE=+5`
- [ ] Create test user via curl
- [ ] Display monitoring instructions
- [ ] Add to `package.json` as `test:manual`

### Task 5: Unit Tests
- [ ] Test `getDeliveryTimeConfig()` with no override (returns default)
- [ ] Test `getDeliveryTimeConfig()` with valid override (+5)
- [ ] Test invalid format throws error
- [ ] Test out-of-range values throw error
- [ ] Test dynamic calculation (now + 5 minutes)

### Task 6: Integration Test
- [ ] Create test with `EVENT_DELIVERY_OVERRIDE=+2`
- [ ] Create user via API
- [ ] Verify event scheduled for ~2 minutes from now (not 9am)

### Task 7: Documentation
- [ ] Update README with manual testing section
- [ ] Document environment variable
- [ ] Add example commands
- [ ] Update [local-development.md](../local-development.md)

---

## Testing Strategy

### Unit Tests
```typescript
describe('getDeliveryTimeConfig', () => {
  it('returns default config when override not set', () => {
    delete process.env.EVENT_DELIVERY_OVERRIDE;
    const config = getDeliveryTimeConfig({ hour: 9, minute: 0 });
    expect(config).toEqual({ hour: 9, minute: 0 });
  });

  it('returns dynamic config when override is +5', () => {
    process.env.EVENT_DELIVERY_OVERRIDE = '+5';
    const now = DateTime.fromObject({ hour: 14, minute: 30 });
    const config = getDeliveryTimeConfig({ hour: 9, minute: 0 }, now);
    expect(config).toEqual({ hour: 14, minute: 35 });
  });

  it('throws error for invalid format', () => {
    process.env.EVENT_DELIVERY_OVERRIDE = 'invalid';
    expect(() => getDeliveryTimeConfig({ hour: 9, minute: 0 }))
      .toThrow('Invalid EVENT_DELIVERY_OVERRIDE');
  });
});
```

### Manual E2E Test
```bash
# Terminal 1: Start server with override
EVENT_DELIVERY_OVERRIDE=+5 npm run dev

# Terminal 2: Create test user
curl -X POST http://localhost:3000/user \
  -H "Content-Type: application/json" \
  -d '{"firstName":"Test","lastName":"User","dateOfBirth":"1990-10-27","timezone":"Australia/Sydney","email":"test@example.com"}'

# Terminal 3: Monitor event execution
docker logs -f localstack-main

# Wait 5 minutes, verify:
# - Event status changes: PENDING â†’ PROCESSING â†’ COMPLETED
# - Webhook delivered
# - executedAt timestamp populated
```

---

## Migration Path

### Phase 1: Global Override (This Story)
- Single env var overrides all event types
- Simple, testing-focused

### Phase 2: Per-Event-Type Rules (Future)
```typescript
EVENT_DELIVERY_RULES={
  "BIRTHDAY": "+5",
  "ANNIVERSARY": "+10"
}
```

### Phase 3: Database-Driven Rules (Future)
```sql
CREATE TABLE delivery_time_rules (
  event_type VARCHAR(50),
  mode VARCHAR(20), -- 'STATIC' or 'DYNAMIC_OFFSET'
  config JSONB
);
```

---

## Dependencies

**Blocked By:**
- None (all prerequisites complete)

**Blocks:**
- Story 4.6 - Comprehensive E2E Smoke Test (needs this for fast testing)

**Related Stories:**
- Story 2.2 - BirthdayEventHandler (configurable delivery time support already exists)
- Story 4.4 - Lambda Deployment (Lambdas need to respect override)

---

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Developers forget to unset override in production | High | Add startup warning if override is active |
| Override not respected in Lambda functions | Medium | Ensure env var passed to Lambda environment |
| Time calculations incorrect across timezones | Medium | Comprehensive unit tests with multiple timezones |

---

## Success Criteria

- âœ… Developer runs `EVENT_DELIVERY_OVERRIDE=+5 npm run dev`
- âœ… Creates user via API
- âœ… Event scheduled for 5 minutes from now (verified in database)
- âœ… Event triggers and completes successfully
- âœ… Total manual test time < 10 minutes (vs. waiting until 9am)

---

## Notes

- **Design Decision:** Global override (not per-event-type) keeps initial implementation simple
- **Future Enhancement:** Could add support for absolute times (e.g., `@14:30` for 2:30 PM)
- **Testing Impact:** Dramatically reduces manual E2E test time from hours to minutes

---

**Created:** 2025-10-27
**Last Updated:** 2025-10-27
**Assigned To:** Claude Sonnet 4.5
**Review Status:** Draft
