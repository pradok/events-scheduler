# Story 4.1: LocalStack Setup for E2E Testing (Community Edition)

---

## Status

Approved

---

## Story

**As a** developer,
**I want** a LocalStack environment configured with Community Edition features,
**so that** I can test the application locally without AWS costs.

---

## Acceptance Criteria

1. LocalStack Community Edition configured in docker-compose.yml
2. Services enabled: Lambda, SQS, EventBridge, CloudWatch Logs, IAM
3. SQS queue created: `bday-events-queue` (for event processing)
4. SQS DLQ created: `bday-events-dlq` (for failed events)
5. EventBridge rule created: `event-scheduler-rule` (triggers every 1 minute)
6. IAM role created: `lambda-execution-role`
7. Init script (`docker/localstack/init-aws.sh`) creates all resources on startup
8. Documentation added: "LocalStack Setup Guide (Community Edition)"
9. NPM scripts updated: `docker:start`, `docker:stop`, `docker:logs`
10. Verification script added to check all resources exist

---

## Tasks / Subtasks

- [x] **Task 1: Update docker-compose.yml with LocalStack** (AC: 1, 2)
  - [ ] Add LocalStack service to `docker/docker-compose.yml`
  - [ ] Configure LocalStack Community Edition image: `localstack/localstack:3.1.0`
  - [ ] Enable services: `SERVICES=lambda,sqs,events,logs,iam`
  - [ ] Set `DOCKER_HOST=unix:///var/run/docker.sock` for Lambda mounting
  - [ ] Expose port 4566 for AWS endpoint
  - [ ] Mount init script: `./localstack/init-aws.sh:/etc/localstack/init/ready.d/init-aws.sh`
  - [ ] Add health check endpoint
  - [ ] Reference: [docs/architecture/tech-stack.md - LocalStack 3.1.0]

- [x] **Task 2: Create LocalStack Init Script** (AC: 3, 4, 5, 6, 7)
  - [ ] Create `docker/localstack/init-aws.sh`
  - [ ] Make script executable: `chmod +x docker/localstack/init-aws.sh`
  - [ ] Add shebang: `#!/bin/bash`
  - [ ] **Subtask: Create SQS Queues**
    - [ ] Create main queue: `bday-events-queue`
      ```bash
      awslocal sqs create-queue --queue-name bday-events-queue
      ```
    - [ ] Create DLQ: `bday-events-dlq`
      ```bash
      awslocal sqs create-queue --queue-name bday-events-dlq
      ```
    - [ ] Configure DLQ redrive policy on main queue (maxReceiveCount: 3)
    - [ ] Save queue URLs to environment variables
  - [ ] **Subtask: Create IAM Role**
    - [ ] Create `lambda-execution-role` with trust policy
    - [ ] Attach AWS managed policies: `AWSLambdaBasicExecutionRole`, `AmazonSQSFullAccess`, `AmazonEventBridgeFullAccess`
    - [ ] Save role ARN to environment variable
  - [ ] **Subtask: Create EventBridge Rule**
    - [ ] Create rule: `event-scheduler-rule`
    - [ ] Set schedule expression: `rate(1 minute)`
    - [ ] Target will be added in Story 4.4 when Lambda is deployed
  - [ ] Add logging for each resource creation
  - [ ] Add error handling (exit on failure)

- [x] **Task 3: Create Verification Script** (AC: 10)
  - [ ] Create `scripts/verify-localstack.sh`
  - [ ] Make script executable: `chmod +x scripts/verify-localstack.sh`
  - [ ] **Verify LocalStack Health**
    ```bash
    curl -s http://localhost:4566/_localstack/health | jq
    ```
  - [ ] **Verify SQS Queues**
    ```bash
    awslocal sqs list-queues | grep bday-events-queue
    awslocal sqs list-queues | grep bday-events-dlq
    ```
  - [ ] **Verify IAM Role**
    ```bash
    awslocal iam get-role --role-name lambda-execution-role
    ```
  - [ ] **Verify EventBridge Rule**
    ```bash
    awslocal events list-rules | grep event-scheduler-rule
    ```
  - [ ] Print success message if all checks pass
  - [ ] Exit with error code if any check fails

- [x] **Task 4: Update NPM Scripts** (AC: 9)
  - [ ] Add to `package.json` scripts:
    ```json
    {
      "docker:start": "docker-compose -f docker/docker-compose.yml up -d",
      "docker:stop": "docker-compose -f docker/docker-compose.yml down",
      "docker:logs": "docker-compose -f docker/docker-compose.yml logs -f localstack",
      "docker:verify": "./scripts/verify-localstack.sh"
    }
    ```
  - [ ] Test each script locally
  - [ ] Ensure `docker:start` waits for LocalStack to be ready (health check)

- [x] **Task 5: Create LocalStack Setup Documentation** (AC: 8)
  - [ ] Create `docs/localstack-setup-community.md`
  - [ ] **Section: Overview**
    - [ ] Explain what LocalStack is
    - [ ] List supported AWS services (Lambda, SQS, EventBridge, CloudWatch Logs, IAM)
    - [ ] Mention Community Edition limitations (no RDS, X-Ray, SNS/SES)
  - [ ] **Section: Prerequisites**
    - [ ] Docker Desktop installed and running
    - [ ] AWS CLI installed (`aws --version`)
    - [ ] `awslocal` wrapper installed (`pip install awscli-local`)
  - [ ] **Section: Getting Started**
    - [ ] Step 1: Start LocalStack: `npm run docker:start`
    - [ ] Step 2: Verify resources: `npm run docker:verify`
    - [ ] Step 3: View logs: `npm run docker:logs`
    - [ ] Step 4: Stop LocalStack: `npm run docker:stop`
  - [ ] **Section: Accessing LocalStack**
    - [ ] AWS endpoint URL: `http://localhost:4566`
    - [ ] Example awslocal command: `awslocal sqs list-queues`
    - [ ] Example AWS SDK config:
      ```typescript
      const sqsClient = new SQSClient({
        endpoint: 'http://localhost:4566',
        region: 'us-east-1',
        credentials: { accessKeyId: 'test', secretAccessKey: 'test' }
      });
      ```
  - [ ] **Section: Created Resources**
    - [ ] Table listing all resources (queues, IAM role, EventBridge rule)
    - [ ] Include ARNs and URLs for each resource
  - [ ] **Section: Troubleshooting**
    - [ ] LocalStack not starting ‚Üí Check Docker running
    - [ ] Resources not created ‚Üí Check init script logs: `npm run docker:logs`
    - [ ] Port 4566 already in use ‚Üí Stop conflicting service
  - [ ] **Section: Community Edition Limitations**
    - [ ] No RDS (use Docker PostgreSQL instead)
    - [ ] No X-Ray tracing
    - [ ] No SNS/SES (Phase 2+ feature)
    - [ ] Link to Story 4.2 for Pro Edition option

- [x] **Task 6: Update Environment Variables** (AC: 2, 3) - SKIPPED: Already configured in existing .env files
  - [ ] Update `.env.example` with LocalStack configuration:
    ```bash
    # LocalStack Configuration
    AWS_ENDPOINT_URL=http://localhost:4566
    AWS_REGION=us-east-1
    AWS_ACCESS_KEY_ID=test
    AWS_SECRET_ACCESS_KEY=test

    # SQS Queue URLs (set by init script)
    SQS_QUEUE_URL=http://localhost:4566/000000000000/bday-events-queue
    SQS_DLQ_URL=http://localhost:4566/000000000000/bday-events-dlq
    ```
  - [ ] Create `.env.localstack` for local development overrides
  - [ ] Document in README.md: "Copy `.env.example` to `.env` for local development"

- [x] **Task 7: Test LocalStack Setup End-to-End** (AC: All)
  - [ ] Clean slate: `npm run docker:stop`
  - [ ] Start LocalStack: `npm run docker:start`
  - [ ] Wait for health check (30 seconds)
  - [ ] Run verification: `npm run docker:verify` (should pass)
  - [ ] Manually check each resource:
    ```bash
    awslocal sqs list-queues
    awslocal iam list-roles
    awslocal events list-rules
    ```
  - [ ] Check CloudWatch Logs ready:
    ```bash
    awslocal logs describe-log-groups
    ```
  - [ ] Stop LocalStack: `npm run docker:stop`
  - [ ] Document any issues in Debug Log

---

## Dev Notes

### LocalStack Community Edition vs Pro

**Community Edition (FREE) - Used in This Story:**
- ‚úÖ Lambda, SQS, EventBridge, CloudWatch Logs, IAM
- ‚úÖ Sufficient for MVP E2E testing
- ‚úÖ No license required
- ‚ùå No RDS (use Docker PostgreSQL)
- ‚ùå No X-Ray distributed tracing
- ‚ùå No SNS/SES (email/SMS for Phase 2+)

**Pro Edition (PAID) - Optional Story 4.2:**
- ‚úÖ All Community Edition features
- ‚úÖ RDS PostgreSQL (alternative to Docker)
- ‚úÖ X-Ray tracing
- ‚úÖ SNS/SES (for future notification features)
- ‚úÖ LocalStack Web UI dashboard
- üí∞ Requires license ($$$)

**Decision:** Use Community Edition for MVP. Pro Edition deferred to Story 4.2 (optional).

### Why LocalStack for E2E Testing?

**Benefits:**
1. **No AWS Costs** - Run unlimited tests without AWS charges
2. **Fast Feedback** - Local testing is faster than deploying to AWS
3. **Offline Development** - No internet required
4. **Reproducible Tests** - Same environment every time
5. **CI/CD Friendly** - Easy to run in GitHub Actions

**What LocalStack Simulates:**
- Lambda function execution (Node.js runtime)
- SQS message queuing (FIFO and standard queues)
- EventBridge scheduled rules (cron and rate expressions)
- CloudWatch Logs (log groups and streams)
- IAM roles and policies

### Integration with Existing Infrastructure

**Current Setup (from Previous Stories):**
- Docker Compose runs PostgreSQL 16 (Story 1.2)
- Lambdas built with `scripts/lambda-build.sh` (Story 2.3)
- Lambdas deployed with `scripts/deploy-lambda.js` (Story 2.6)

**This Story Adds:**
- LocalStack service to Docker Compose
- Init script to create AWS resources
- Verification script to check LocalStack health

**Story 4.4 Will Add:**
- Lambda deployment to LocalStack
- EventBridge rule target configuration

### LocalStack Init Script Pattern

**Why Init Script?**
- Resources created automatically on LocalStack startup
- Idempotent - script can run multiple times safely
- Version controlled - resources defined as code

**Init Script Location:**
`docker/localstack/init-aws.sh` ‚Üí Mounted to `/etc/localstack/init/ready.d/`

**Execution Timing:**
LocalStack runs init scripts after all services are ready (health check passes).

### awslocal CLI Wrapper

**What is awslocal?**
- Wrapper around `aws` CLI
- Automatically sets `--endpoint-url=http://localhost:4566`
- Simplifies commands: `awslocal sqs list-queues` vs `aws --endpoint-url=http://localhost:4566 sqs list-queues`

**Installation:**
```bash
pip install awscli-local
```

**Usage:**
```bash
# List SQS queues
awslocal sqs list-queues

# Create S3 bucket (for future stories)
awslocal s3 mb s3://my-bucket

# List Lambda functions (Story 4.4)
awslocal lambda list-functions
```

### SQS Queue Configuration

**Main Queue: `bday-events-queue`**
- Purpose: Event execution messages sent by scheduler
- Visibility timeout: 30 seconds (default)
- Message retention: 4 days (default)
- Redrive policy: Send to DLQ after 3 failed attempts

**Dead Letter Queue: `bday-events-dlq`**
- Purpose: Capture events that failed max retries
- Manual inspection and reprocessing
- Retention: 14 days (longer than main queue)

**Redrive Policy Example:**
```json
{
  "deadLetterTargetArn": "arn:aws:sqs:us-east-1:000000000000:bday-events-dlq",
  "maxReceiveCount": 3
}
```

### EventBridge Scheduler Rule

**Rule: `event-scheduler-rule`**
- Schedule: `rate(1 minute)` - Runs every 1 minute
- Target: `event-scheduler` Lambda (added in Story 4.4)
- State: ENABLED

**Why 1 minute?**
- MVP requirement: Check for ready events every minute
- Phase 2+ may increase frequency (30 seconds)

### IAM Role for Lambda

**Role: `lambda-execution-role`**
- Trust policy: Allow Lambda service to assume role
- Policies:
  - `AWSLambdaBasicExecutionRole` - CloudWatch Logs write permission
  - `AmazonSQSFullAccess` - Send/receive SQS messages
  - `AmazonEventBridgeFullAccess` - EventBridge integration

**Trust Policy:**
```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Principal": { "Service": "lambda.amazonaws.com" },
    "Action": "sts:AssumeRole"
  }]
}
```

### Testing Strategy

**Verification Script Checks:**
1. ‚úÖ LocalStack health endpoint responds
2. ‚úÖ SQS main queue exists
3. ‚úÖ SQS DLQ exists
4. ‚úÖ IAM role exists
5. ‚úÖ EventBridge rule exists

**Manual Verification (Optional):**
```bash
# Send test message to queue
awslocal sqs send-message \
  --queue-url http://localhost:4566/000000000000/bday-events-queue \
  --message-body '{"test": "message"}'

# Receive message
awslocal sqs receive-message \
  --queue-url http://localhost:4566/000000000000/bday-events-queue
```

### Environment Variables

**LocalStack Specific:**
- `AWS_ENDPOINT_URL` - Point SDK to LocalStack
- `AWS_REGION` - Any region (LocalStack ignores)
- `AWS_ACCESS_KEY_ID` - Dummy value ("test")
- `AWS_SECRET_ACCESS_KEY` - Dummy value ("test")

**Application Specific:**
- `SQS_QUEUE_URL` - Full LocalStack queue URL
- `SQS_DLQ_URL` - Full LocalStack DLQ URL

### File Locations

**Files to Create:**
- `docker/localstack/init-aws.sh` (NEW)
- `scripts/verify-localstack.sh` (NEW)
- `docs/localstack-setup-community.md` (NEW)
- `.env.localstack` (NEW)

**Files to Modify:**
- `docker/docker-compose.yml` (ADD LocalStack service)
- `package.json` (ADD npm scripts)
- `.env.example` (ADD LocalStack variables)

### Dependencies

**No new npm dependencies needed!**

**System Dependencies:**
- Docker Desktop (already required)
- AWS CLI (already required)
- awslocal wrapper: `pip install awscli-local` (NEW)

---

## Testing

### Verification Steps

**After completing this story, the following should work:**

1. **Start LocalStack:**
   ```bash
   npm run docker:start
   ```
   Expected: LocalStack container starts, runs init script, health check passes

2. **Verify Resources:**
   ```bash
   npm run docker:verify
   ```
   Expected: All checks pass (queues, IAM role, EventBridge rule exist)

3. **View Logs:**
   ```bash
   npm run docker:logs
   ```
   Expected: See init script output, resource creation logs

4. **Manual Resource Check:**
   ```bash
   awslocal sqs list-queues
   awslocal iam list-roles
   awslocal events list-rules
   ```
   Expected: See created resources

5. **Stop LocalStack:**
   ```bash
   npm run docker:stop
   ```
   Expected: Container stops cleanly

### Expected Output

**Verification Script Success:**
```
‚úÖ LocalStack health check passed
‚úÖ SQS queue 'bday-events-queue' exists
‚úÖ SQS DLQ 'bday-events-dlq' exists
‚úÖ IAM role 'lambda-execution-role' exists
‚úÖ EventBridge rule 'event-scheduler-rule' exists

All LocalStack resources verified successfully!
```

**Verification Script Failure Example:**
```
‚úÖ LocalStack health check passed
‚úÖ SQS queue 'bday-events-queue' exists
‚ùå SQS DLQ 'bday-events-dlq' NOT FOUND

Verification failed! Check init script logs: npm run docker:logs
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-27 | 1.0 | Initial draft created from Epic 4 | James (Developer) |

---

## Dev Agent Record

### Agent Model Used

**Claude Sonnet 4.5** (claude-sonnet-4-5-20250929)

### Debug Log References

No blocking issues encountered. All tests passed successfully.

**Test Results:**

- ‚úÖ LocalStack health check: PASS
- ‚úÖ SQS queue creation: PASS
- ‚úÖ SQS DLQ creation: PASS
- ‚úÖ DLQ redrive policy (maxReceiveCount=3): PASS
- ‚úÖ IAM role creation: PASS
- ‚úÖ EventBridge rule creation: PASS
- ‚úÖ CloudWatch Logs service: PASS
- ‚úÖ `docker:reset` workflow: PASS (clean slate confirmed)

### Completion Notes

**Implementation Approach:**

- Found existing LocalStack setup (docker-compose.yml + init-aws.sh) from previous stories
- Enhanced existing implementation rather than rewriting from scratch
- Added missing components to meet all Story 4.1 ACs

**Changes Made:**

1. **docker-compose.yml** - Added `logs` and `iam` to SERVICES env var (kept existing `apigateway` and `sns` for future-proofing)
2. **init-aws.sh** - Added DLQ redrive policy configuration with maxReceiveCount=3
3. **scripts/verify-localstack.sh** - Created comprehensive verification script (uses `docker exec` to run awslocal inside container - no host AWS CLI required!)
4. **package.json** - Added `docker:verify` NPM script
5. **docs/localstack-setup-community.md** - Created complete developer guide with troubleshooting

**Key Design Decisions:**

- Verification script runs awslocal inside LocalStack container (no AWS CLI installation needed on host)
- Kept extra services (apigateway, sns) in SERVICES for future stories
- Emphasized `docker:reset` as the "clean slate" command per user requirement

**All 10 Acceptance Criteria Met:**

- AC 1-7: Infrastructure configured (docker-compose, init script, resources created)
- AC 8: Documentation created
- AC 9: NPM scripts updated (docker:verify added)
- AC 10: Verification script created and tested

### File List

**Modified Files:**

- `docker/docker-compose.yml` - Updated SERVICES env var
- `docker/localstack/init-aws.sh` - Added DLQ redrive policy
- `package.json` - Added `docker:verify` script

**Created Files:**

- `scripts/verify-localstack.sh` - LocalStack resource verification script
- `docs/localstack-setup-community.md` - Complete LocalStack setup guide

---

## QA Results

*This section will be populated by QA agent after implementation*
