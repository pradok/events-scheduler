# Story 1.11c: Implement Structured Logging Infrastructure

---

## Status

Approved - Ready for Implementation

---

## Context

Story 1.11b QA review (Gate: CONCERNS) identified that 6 files use `console.error()` for error logging, violating **coding-standards.md** Section 1: "No Console.log in Production".

**Current Violations:**
- `src/modules/event-scheduling/application/event-handlers/CreateBirthdayEventOnUserCreatedHandler.ts:47`
- `src/modules/event-scheduling/application/event-handlers/RescheduleEventsOnUserBirthdayChangedHandler.ts:47`
- `src/modules/event-scheduling/application/event-handlers/RescheduleEventsOnUserTimezoneChangedHandler.ts:51`
- `src/modules/event-scheduling/application/event-handlers/DeleteEventsOnUserDeletedHandler.ts:42`
- `src/modules/user/application/use-cases/GetUserUseCase.ts` (if exists)
- `src/modules/user/application/use-cases/DeleteUserUseCase.ts` (if exists)

**Why This Matters:**
- Production monitoring systems (CloudWatch, DataDog, etc.) require structured JSON logs
- `console.error` logs are unstructured and difficult to parse/query
- Pino provides high-performance structured logging with minimal overhead
- Proper logging is critical for debugging production issues

---

## Story

**As a** DevOps engineer,
**I want** structured JSON logging using Pino logger,
**so that** production errors are properly captured, searchable, and monitorable.

---

## Acceptance Criteria

**Logger Infrastructure:**

1. Pino logger configured in `src/shared/logger.ts` with production-ready settings
2. Logger exports singleton instance for application-wide use
3. Log levels configurable via environment variable (LOG_LEVEL)
4. Logs output as structured JSON with timestamp, level, context fields

**Code Refactoring:**

5. All 6 `console.error()` calls replaced with `logger.error()`
6. Error logs include structured context (userId, eventType, error message, stack trace)
7. No remaining `console.log` or `console.error` in src/ directory

**ESLint Enforcement:**

8. ESLint rule updated to forbid console.log/console.error
9. ESLint allows `logger` imports from shared/logger
10. Build passes with no ESLint errors/warnings

**Testing:**

11. Unit tests for logger configuration
12. All 288 existing tests still passing
13. No performance degradation (Pino is high-performance)

---

## Tasks / Subtasks

- [ ] **Task 1: Create Pino Logger Infrastructure**
  - [ ] Install Pino: `npm install pino pino-pretty`
  - [ ] Create `src/shared/logger.ts` with Pino configuration
  - [ ] Configure log levels (ERROR, WARN, INFO, DEBUG)
  - [ ] Add environment variable support (LOG_LEVEL, NODE_ENV)
  - [ ] Use pino-pretty for development, JSON for production
  - [ ] Add request ID generation for tracing

- [ ] **Task 2: Replace console.error in Event Handlers**
  - [ ] Update CreateBirthdayEventOnUserCreatedHandler.ts
  - [ ] Update RescheduleEventsOnUserBirthdayChangedHandler.ts
  - [ ] Update RescheduleEventsOnUserTimezoneChangedHandler.ts
  - [ ] Update DeleteEventsOnUserDeletedHandler.ts
  - [ ] Ensure structured context preserved (userId, eventType, error, stack)

- [ ] **Task 3: Replace console.error in Use Cases (if exists)**
  - [ ] Update GetUserUseCase.ts
  - [ ] Update DeleteUserUseCase.ts

- [ ] **Task 4: Update ESLint Configuration**
  - [ ] Add rule: `'no-console': ['error', { allow: [] }]`
  - [ ] Verify no console.* calls remain in src/
  - [ ] Run `npx eslint src/ --max-warnings 0`

- [ ] **Task 5: Update ESLint Naming Convention for Zod Schemas**
  - [ ] Add exception for PascalCase Zod schema variables
  - [ ] Run `npx eslint src/modules/ --max-warnings 0`
  - [ ] Verify all 4 naming warnings resolved

- [ ] **Task 6: Create Logger Unit Tests**
  - [ ] Test logger initialization
  - [ ] Test log level filtering
  - [ ] Test structured field output
  - [ ] Verify JSON output in production mode

- [ ] **Task 7: Run Full Test Suite**
  - [ ] Run `npm test` - all 288 tests should pass
  - [ ] Run `npx tsc --noEmit` - TypeScript compilation
  - [ ] Run `npx eslint src/ --max-warnings 0` - no warnings
  - [ ] Verify coverage remains > 97%

---

## Technical Implementation

### Pino Logger Configuration

```typescript
// src/shared/logger.ts
import pino from 'pino';

const isDevelopment = process.env.NODE_ENV === 'development';
const logLevel = process.env.LOG_LEVEL || 'info';

export const logger = pino({
  level: logLevel,
  transport: isDevelopment
    ? {
        target: 'pino-pretty',
        options: {
          colorize: true,
          translateTime: 'HH:MM:ss Z',
          ignore: 'pid,hostname',
        },
      }
    : undefined, // JSON output in production
  base: {
    env: process.env.NODE_ENV || 'development',
  },
  timestamp: pino.stdTimeFunctions.isoTime,
});
```

### Usage Pattern

```typescript
// BEFORE (violates coding standards)
console.error('Failed to create birthday event', {
  userId: event.userId,
  error: error.message,
});

// AFTER (correct structured logging)
import { logger } from '../../../../shared/logger';

logger.error({
  msg: 'Failed to create birthday event from UserCreated event',
  eventType: event.eventType,
  userId: event.userId,
  aggregateId: event.aggregateId,
  error: error instanceof Error ? error.message : String(error),
  stack: error instanceof Error ? error.stack : undefined,
});
```

### ESLint Configuration Update

```javascript
// .eslintrc.js
module.exports = {
  rules: {
    // Forbid all console usage
    'no-console': ['error', { allow: [] }],

    // Allow PascalCase for Zod schemas
    '@typescript-eslint/naming-convention': [
      'error',
      {
        selector: 'variable',
        format: ['camelCase', 'UPPER_CASE'],
      },
      {
        selector: 'variable',
        filter: 'Schema$',
        format: ['PascalCase'],
      },
      {
        selector: 'interface',
        format: ['PascalCase'],
        custom: {
          regex: '^I[A-Z]',
          match: false,
        },
      },
    ],
  },
};
```

---

## References

- **Story 1.11b QA Review:** docs/qa/gates/1.11b-refactor-bounded-context-violations.yml
- **Coding Standards:** docs/architecture/coding-standards.md Section 1
- **Pino Documentation:** https://getpino.io/
- **ESLint no-console rule:** https://eslint.org/docs/rules/no-console

---

## Estimated Effort

- Logger Infrastructure: ~15 minutes
- Refactor 6 files: ~20 minutes
- ESLint Configuration: ~5 minutes
- Testing & Verification: ~10 minutes

**Total: ~50 minutes**

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Created story to address Story 1.11b QA review findings | Quinn (Test Architect) |

---

## Acceptance

**Definition of Done:**
- ✅ Pino logger infrastructure created and configured
- ✅ All console.error calls replaced with logger.error
- ✅ ESLint updated to forbid console usage
- ✅ ESLint Zod schema naming warnings resolved
- ✅ All 288 tests passing
- ✅ TypeScript compilation successful
- ✅ ESLint passing with --max-warnings 0
- ✅ Coverage remains > 97%
