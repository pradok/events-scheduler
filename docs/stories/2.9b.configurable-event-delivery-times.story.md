# Story 2.9b: Configurable Event Delivery Times

---

## Status

Approved

---

## Story

**As a** developer,
**I want** event delivery times to be configurable instead of hardcoded,
**so that** I can easily test events without waiting until 9:00 AM and support different event types with different delivery times in the future.

---

## Acceptance Criteria

1. Delivery time (hour and minute) is configurable via code constants (not hardcoded in BirthdayEventHandler)
2. BirthdayEventHandler accepts delivery time configuration via constructor (defaults to 9:00 AM)
3. Configuration file defines delivery times for all event types (BIRTHDAY: 9:00 AM)
4. All existing unit tests pass without modification (default behavior unchanged)
5. New unit tests verify custom delivery times work correctly
6. Integration tests can override delivery time for fast test execution

---

## Tasks / Subtasks

- [ ] **Task 1: Create Event Delivery Time Configuration File** (AC: 1, 3)
  - [ ] Create new file: `src/modules/event-scheduling/config/event-delivery-times.ts`
  - [ ] Define `EventDeliveryTimeConfig` interface with `hour` (0-23) and `minute` (0-59)
  - [ ] Export `EVENT_DELIVERY_TIMES` constant with BIRTHDAY configuration:
    ```typescript
    export const EVENT_DELIVERY_TIMES = {
      BIRTHDAY: { hour: 9, minute: 0 },
    } as const;
    ```
  - [ ] Add JSDoc comments explaining purpose and usage
  - [ ] Reference: [Source: Discussion with user about code config vs database config]

- [ ] **Task 2: Update BirthdayEventHandler to Accept Configuration** (AC: 2)
  - [ ] Add constructor parameter: `config: EventDeliveryTimeConfig = EVENT_DELIVERY_TIMES.BIRTHDAY`
  - [ ] Store config as private readonly property
  - [ ] Update `createBirthdayDateTime()` method to use `this.config.hour` and `this.config.minute` instead of hardcoded `9` and `0`
  - [ ] Verify default behavior: If no config passed, uses 9:00 AM (backward compatible)
  - [ ] Reference: [Source: src/modules/event-scheduling/domain/services/event-handlers/BirthdayEventHandler.ts:105-113]

- [ ] **Task 3: Update All BirthdayEventHandler Instantiations** (AC: 4)
  - [ ] Find all locations where BirthdayEventHandler is instantiated
  - [ ] Verify they work with default constructor (no config parameter needed)
  - [ ] Production code locations:
    - `CreateBirthdayEventUseCase`
    - `ExecuteEventUseCase` (Story 2.9)
    - `RescheduleEventsOnUserTimezoneChangedHandler`
    - `RescheduleEventsOnUserBirthdayChangedHandler`
    - Any Lambda handlers or factories
  - [ ] No changes needed if using default constructor
  - [ ] Reference: [Source: Grep results showing BirthdayEventHandler usage]

- [ ] **Task 4: Update Unit Tests to Verify Configurable Delivery Times** (AC: 5)
  - [ ] Add new test: "should use configured delivery time instead of default 9:00 AM"
    - Create BirthdayEventHandler with custom config: `{ hour: 15, minute: 30 }` (3:30 PM)
    - Calculate next occurrence
    - Verify result has hour=15, minute=30
  - [ ] Add new test: "should use default 9:00 AM when no config provided"
    - Create BirthdayEventHandler with no constructor arguments
    - Calculate next occurrence
    - Verify result has hour=9, minute=0
  - [ ] Add new test: "should respect configured minute offset"
    - Create BirthdayEventHandler with config: `{ hour: 9, minute: 15 }` (9:15 AM)
    - Calculate next occurrence
    - Verify result has hour=9, minute=15
  - [ ] Verify all existing BirthdayEventHandler.test.ts tests still pass (no regression)
  - [ ] Reference: [Source: src/modules/event-scheduling/domain/services/event-handlers/BirthdayEventHandler.test.ts]

- [ ] **Task 5: Verify Integration Tests Pass** (AC: 6)
  - [ ] Run all integration tests in `src/modules/event-scheduling/`
  - [ ] Verify no regressions (all tests pass with default 9:00 AM behavior)
  - [ ] Document pattern for E2E tests to use custom delivery times:
    ```typescript
    // E2E test example (for Story 2.10)
    const fiveMinutesFromNow = DateTime.now().plus({ minutes: 5 });
    const testConfig = {
      hour: fiveMinutesFromNow.hour,
      minute: fiveMinutesFromNow.minute,
    };
    const handler = new BirthdayEventHandler(testConfig);
    ```
  - [ ] Add comment to configuration file explaining testing use case
  - [ ] Reference: [Source: Story 2.10 - End-to-End Scheduling Flow Test]

- [ ] **Task 6: Update Documentation** (AC: 1, 2, 3)
  - [ ] Update `docs/architecture/data-models.md` to reference configurable delivery times
  - [ ] Update `BirthdayEventHandler.ts` JSDoc to document constructor parameter
  - [ ] Add inline comment explaining why delivery time is configurable (testing, future extensibility)
  - [ ] Optional: Add note to Story 2.9 Dev Notes about this enhancement
  - [ ] Reference: [Source: docs/architecture/data-models.md]

---

## Dev Notes

### Why This Story Exists

**Context from Story 2.9:**
- Story 2.9 implemented next year event generation with hardcoded 9:00 AM delivery time
- BirthdayEventHandler.ts line 109: `hour: 9` is hardcoded in `createBirthdayDateTime()`
- This creates testing challenges: E2E tests must wait until 9:00 AM or create events in the past

**User Request:**
- "I think I want to make it configurable so it becomes easier to test as well"
- "Not a 9am rule though it's a business requirement but if it's configurable then we are confident that it'd run at any time for that event"
- "Why can't we just use a config object in code instead of having in db. The requirements are simple for now and they won't change frequently, they are more like constants."

**Decision: Code Configuration (Not Database)**

Rationale:
- ✅ **Simple** - No database table, migrations, or repository needed
- ✅ **Fast** - Zero database queries (instant access)
- ✅ **Easy testing** - Pass custom config to constructor for tests
- ✅ **Version controlled** - Config changes tracked in git
- ✅ **Type-safe** - TypeScript validates at compile time
- ✅ **Fits requirements** - "Won't change frequently" = perfect for code constants

Database configuration would be overkill for this use case. Code constants are simpler, faster, and easier to test.

### Architecture Context

#### Current Implementation (Hardcoded)

**File:** `src/modules/event-scheduling/domain/services/event-handlers/BirthdayEventHandler.ts`

**Lines 105-113:**

```typescript
return referenceInZone.set({
  year,
  month: targetMonth,
  day: targetDay,
  hour: 9,        // ← HARDCODED: 9:00 AM
  minute: 0,      // ← HARDCODED: 0 minutes
  second: 0,
  millisecond: 0,
});
```

**Problem:**
- Value `9` appears only in production code (good DRY principle)
- BUT: Cannot test events at different times without modifying code
- E2E tests (Story 2.10) need events that execute "soon" (not at 9 AM)

[Source: src/modules/event-scheduling/domain/services/event-handlers/BirthdayEventHandler.ts:105-113]

#### New Implementation (Configurable)

**Configuration File Pattern:**

```typescript
// src/modules/event-scheduling/config/event-delivery-times.ts

export interface EventDeliveryTimeConfig {
  hour: number;    // 0-23
  minute: number;  // 0-59
}

export const EVENT_DELIVERY_TIMES: Record<string, EventDeliveryTimeConfig> = {
  BIRTHDAY: {
    hour: 9,
    minute: 0,
  },
  // Future: Add more event types
  // ANNIVERSARY: { hour: 12, minute: 0 },
  // REMINDER: { hour: 15, minute: 0 },
} as const;
```

**BirthdayEventHandler Update:**

```typescript
export class BirthdayEventHandler implements IEventHandler {
  public readonly eventType = 'BIRTHDAY';

  // Constructor with default config (backward compatible)
  constructor(
    private readonly config: EventDeliveryTimeConfig = EVENT_DELIVERY_TIMES.BIRTHDAY
  ) {}

  private createBirthdayDateTime(
    referenceInZone: DateTime,
    year: number,
    month: number,
    day: number,
    isLeapYearBirthday: boolean
  ): DateTime {
    // ... leap year logic ...

    return referenceInZone.set({
      year,
      month: targetMonth,
      day: targetDay,
      hour: this.config.hour,    // ← Use config
      minute: this.config.minute, // ← Use config
      second: 0,
      millisecond: 0,
    });
  }
}
```

**Benefits:**
- Default behavior unchanged (9:00 AM)
- Tests can override: `new BirthdayEventHandler({ hour: 15, minute: 30 })`
- Production code remains simple: `new BirthdayEventHandler()` (uses default)

#### Testing Strategy

**Unit Tests (Fast, Isolated):**

```typescript
it('should calculate next occurrence at custom delivery time', () => {
  const customConfig = { hour: 15, minute: 30 }; // 3:30 PM
  const handler = new BirthdayEventHandler(customConfig);

  const nextBirthday = handler.calculateNextOccurrence(userInfo);

  expect(nextBirthday.hour).toBe(15);
  expect(nextBirthday.minute).toBe(30);
});
```

**Integration Tests (Real Dependencies):**

```typescript
it('should create event with custom delivery time', async () => {
  const testConfig = { hour: 10, minute: 15 }; // 10:15 AM
  const handler = new BirthdayEventHandler(testConfig);
  const useCase = new CreateBirthdayEventUseCase(
    eventRepository,
    handler,
    timezoneService
  );

  const event = await useCase.execute(user);

  // Verify targetTimestampLocal has 10:15 AM
  expect(event.targetTimestampLocal.hour).toBe(10);
  expect(event.targetTimestampLocal.minute).toBe(15);
});
```

**E2E Tests (Story 2.10 - Complete System):**

```typescript
it('should execute event end-to-end', async () => {
  // Create event that executes in 5 minutes (not 9 AM)
  const fiveMinutesFromNow = DateTime.now().plus({ minutes: 5 });
  const testConfig = {
    hour: fiveMinutesFromNow.hour,
    minute: fiveMinutesFromNow.minute,
  };

  const handler = new BirthdayEventHandler(testConfig);

  // Create user and event with custom delivery time
  // ... E2E test completes in ~5 minutes instead of waiting until 9 AM
});
```

[Source: Story 2.10 - End-to-End Scheduling Flow Test]

#### Backward Compatibility

**No Breaking Changes:**

✅ **Existing code works unchanged:**
```typescript
// Production code - uses default 9:00 AM
const handler = new BirthdayEventHandler();
```

✅ **Existing tests work unchanged:**
- All tests that expect 9:00 AM continue to pass
- Tests using `new BirthdayEventHandler()` get default behavior

✅ **Future extensibility:**
- Add new event types to config without modifying handler code
- Support per-environment config if needed (dev vs prod)

#### Alternative Approaches (Rejected)

**Option 1: Database Configuration Table**

```sql
CREATE TABLE event_type_configs (
  event_type VARCHAR(50),
  delivery_hour INT,
  delivery_minute INT
);
```

**Rejected because:**
- ❌ Overkill for "won't change frequently"
- ❌ Requires migration, repository, service layer
- ❌ Slower (database query on every handler creation)
- ❌ More complex testing (seed database in tests)
- ❌ Harder to version control config changes

**Option 2: Environment Variables**

```bash
BIRTHDAY_DELIVERY_HOUR=9
BIRTHDAY_DELIVERY_MINUTE=0
```

**Rejected because:**
- ❌ Not type-safe (string parsing required)
- ❌ Harder to test (modify environment in tests)
- ❌ Can't support multiple event types easily
- ❌ Config scattered across environment (not co-located)

**Option 3: Keep Hardcoded, Override in Tests via Mocking**

```typescript
// Mock DateTime.now() to return time when event should execute
jest.spyOn(DateTime, 'now').mockReturnValue(mockTime);
```

**Rejected because:**
- ❌ Fragile (mocking global DateTime.now affects entire test)
- ❌ Confusing (test time != real time)
- ❌ Doesn't solve extensibility (still can't add new event types)

**Winner: Code Configuration with Constructor Injection**

Simple, fast, testable, type-safe, and fits the requirements perfectly.

#### File Locations

**New Files:**
- `src/modules/event-scheduling/config/event-delivery-times.ts` - Configuration constants

**Modified Files:**
- `src/modules/event-scheduling/domain/services/event-handlers/BirthdayEventHandler.ts` - Add constructor parameter
- `src/modules/event-scheduling/domain/services/event-handlers/BirthdayEventHandler.test.ts` - Add configuration tests

**Files to Verify (No Changes Expected):**
- `src/modules/event-scheduling/application/use-cases/CreateBirthdayEventUseCase.ts` - Uses default constructor
- `src/modules/event-scheduling/application/use-cases/ExecuteEventUseCase.ts` - Uses default constructor
- All integration tests - Should pass with default 9:00 AM behavior

### Testing

#### Test Framework

- **Framework:** Jest 29.7.0
- **Pattern:** AAA (Arrange, Act, Assert)
- **Coverage:** Maintain ≥80% for BirthdayEventHandler

[Source: docs/architecture/test-strategy.md#Unit-Tests]

#### Test File Location

- **Unit Tests:** `src/modules/event-scheduling/domain/services/event-handlers/BirthdayEventHandler.test.ts` (colocated)

[Source: docs/architecture/test-strategy.md#File-Convention]

#### Key Test Scenarios

**Unit Tests (New):**
1. Custom delivery time (15:30) produces correct next occurrence
2. Default constructor (no config) uses 9:00 AM
3. Minute offset (9:15 AM) works correctly
4. Edge case: Midnight (0:00) works correctly
5. Edge case: 11:59 PM works correctly

**Unit Tests (Existing - Verify No Regression):**
1. Next birthday calculation (same year, next year)
2. Leap year handling (Feb 29 → Feb 28)
3. Timezone conversions
4. Message formatting

**Integration Tests (Existing - Verify No Regression):**
1. CreateBirthdayEventUseCase creates events with correct timestamps
2. ExecuteEventUseCase generates next year events at 9:00 AM
3. Timezone change recalculation uses 9:00 AM

[Source: docs/architecture/test-strategy.md#Test-Pyramid]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-26 | 1.0 | Created Story 2.9b for Configurable Event Delivery Times | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Implementation Summary

(To be filled by dev agent)

### Changes Made

(To be filled by dev agent)

### File List

(To be filled by dev agent)

---

## QA Results

(To be filled by QA agent after story completion)
