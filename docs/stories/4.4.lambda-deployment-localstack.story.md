# Story 4.4: Lambda Deployment to LocalStack

**Epic:** 4 - End-to-End Testing & Manual Testing Infrastructure
**Status:** Complete ✅
**Priority:** High
**Estimated Effort:** 3 hours
**Agent Model Used:** Claude Sonnet 4.5

---

## Story

**As a** developer,
**I want** application Lambdas automatically deployed to LocalStack,
**so that** I can test the complete serverless architecture locally.

---

## Acceptance Criteria

1. ✅ Build script creates Lambda deployment packages (existing: `scripts/lambda-build.sh`)
2. ✅ Deployment script deploys to LocalStack (existing: `scripts/deploy-lambda.js`)
3. ✅ Both Lambdas deployed: `event-scheduler`, `event-worker`
4. ✅ EventBridge rule connected to `event-scheduler` Lambda
5. ✅ SQS queue connected to `event-worker` Lambda (event source mapping)
6. ✅ Environment variables configured for both Lambdas
7. ✅ NPM script: `npm run lambda:all` (existing)
8. ✅ Deployment verification script checks Lambdas exist and are configured correctly
9. ✅ Documentation updated: "Lambda Deployment to LocalStack"

---

## Deployed Lambdas

### event-scheduler
- **Trigger:** EventBridge rule (`event-scheduler-rule`, every 1 minute)
- **Purpose:** Polls database for PENDING events with targetTimestampUTC in the past
- **Actions:** Claims events (PENDING → PROCESSING), sends to SQS queue
- **Handler:** `src/adapters/primary/lambda/schedulerHandler.ts`
- **Package:** `dist/event-scheduler.zip` (~45MB)

### event-worker
- **Trigger:** SQS queue (`bday-events-queue`, batch size 10)
- **Purpose:** Processes events from SQS, delivers webhooks
- **Actions:** Sends webhook, marks event COMPLETED or FAILED, generates next year event
- **Handler:** `src/adapters/primary/lambda/workerHandler.ts`
- **Package:** `dist/event-worker.zip` (~44MB)

---

## Context

**Previous Stories:**
- **Story 4.1** ✅ - LocalStack Community Edition configured
- **Story 4.3** ✅ - LocalStack Desktop installed and connected

**Next Stories:**
- **Story 4.5** - Manual E2E Testing Workflow Documentation
- **Story 4.6** - Comprehensive End-to-End Smoke Test

**Related Stories:**
- **Story 2.8** - Scheduler Lambda Handler (implementation)
- **Story 2.9** - Worker Lambda Handler (implementation)

---

## Tasks

### Task 1: Verify Build Script
- [x] Confirm `scripts/lambda-build.sh` exists
- [x] Test build script runs successfully
- [x] Verify output: `dist/event-scheduler.zip` and `dist/event-worker.zip`
- [x] Check zip packages contain handler code and Prisma client

### Task 2: Verify Deploy Script
- [x] Confirm `scripts/deploy-lambda.js` exists
- [x] Test deployment script runs successfully
- [x] Verify both Lambdas deployed to LocalStack
- [x] Check EventBridge target configuration
- [x] Check SQS event source mapping

### Task 3: Create Verification Script
- [x] Create `scripts/verify-lambda-deployment.sh`
- [x] Check scheduler Lambda exists
- [x] Check worker Lambda exists
- [x] Check EventBridge rule has targets
- [x] Check SQS event source mapping exists
- [x] Check scheduler environment variables (DATABASE_URL, SQS_QUEUE_URL)
- [x] Check worker environment variables (DATABASE_URL, WEBHOOK_TEST_URL)
- [x] Check Lambda runtime (nodejs20.x)
- [x] Display summary with pass/fail counts

### Task 4: Add NPM Scripts
- [x] Verify `npm run lambda:build` exists
- [x] Verify `npm run lambda:deploy:localstack` exists
- [x] Verify `npm run lambda:all` exists
- [x] Add `npm run lambda:verify` script

### Task 5: Test Full Deployment Flow
- [x] Build Lambdas: `npm run lambda:build`
- [x] Deploy to LocalStack: `npm run lambda:deploy:localstack`
- [x] Verify deployment: `npm run lambda:verify`
- [x] Test manual invocation
- [x] View in LocalStack Desktop

### Task 6: Update Documentation
- [x] Create story file
- [x] Document build/deploy/verify workflow
- [x] Add troubleshooting section

---

## Dev Notes

### Build Script Details

**Location:** `scripts/lambda-build.sh`

**What it does:**
1. Bundles handler TypeScript code with esbuild
2. Copies Prisma client to deployment package
3. Creates zip packages for both Lambdas
4. Outputs size information

**Build time:** ~5-10 seconds

**Package sizes:**
- Scheduler: ~45MB (includes Prisma client)
- Worker: ~44MB (includes Prisma client)

### Deploy Script Details

**Location:** `scripts/deploy-lambda.js`

**What it does:**
1. Fetches SQS queue URL and ARN
2. Deletes existing Lambdas (if they exist)
3. Creates new Lambda functions with:
   - Runtime: nodejs20.x
   - Handler: `schedulerHandler.handler` or `workerHandler.handler`
   - Timeout: 60 seconds
   - Memory: 512MB
   - Environment variables
4. Configures EventBridge target for scheduler
5. Creates SQS event source mapping for worker

**Deploy time:** ~5-10 seconds

### Environment Variables

**Scheduler Lambda:**
```bash
DATABASE_URL=postgresql://bday_user:local_dev_password@host.docker.internal:5432/bday_db
SQS_QUEUE_URL=http://sqs.us-east-1.localhost.localstack.cloud:4566/000000000000/bday-events-queue
AWS_ENDPOINT_URL=http://localstack:4566
AWS_REGION=us-east-1
NODE_ENV=production
LOG_LEVEL=info
```

**Worker Lambda:**
```bash
DATABASE_URL=postgresql://bday_user:local_dev_password@host.docker.internal:5432/bday_db
WEBHOOK_TEST_URL=https://webhook.site/test  (or set via env)
AWS_ENDPOINT_URL=http://localstack:4566
AWS_REGION=us-east-1
NODE_ENV=production
LOG_LEVEL=info
```

**Note:** `host.docker.internal` allows Lambda (running inside LocalStack container) to access PostgreSQL on the host.

### Verification Script

**Location:** `scripts/verify-lambda-deployment.sh`

**Checks performed (11 total):**
1. ✓ Scheduler Lambda exists
2. ✓ Worker Lambda exists
3. ✓ EventBridge rule exists
4. ✓ EventBridge targets configured
5. ✓ SQS event source mapping exists
6. ✓ Scheduler DATABASE_URL configured
7. ✓ Scheduler SQS_QUEUE_URL configured
8. ✓ Worker DATABASE_URL configured
9. ✓ Worker WEBHOOK_TEST_URL configured
10. ✓ Scheduler runtime is nodejs20.x
11. ✓ Worker runtime is nodejs20.x

**Exit codes:**
- 0: All checks passed
- 1: Some checks failed

### NPM Scripts

```bash
# Build Lambda packages
npm run lambda:build

# Deploy to LocalStack
npm run lambda:deploy:localstack

# Verify deployment
npm run lambda:verify

# Build + Deploy (one command)
npm run lambda:all
```

### Manual Testing

**Invoke scheduler manually:**
```bash
docker exec bday-localstack sh -c "awslocal lambda invoke \
  --function-name event-scheduler \
  /tmp/output.json && cat /tmp/output.json"
```

**Invoke worker manually:**
```bash
docker exec bday-localstack sh -c "awslocal lambda invoke \
  --function-name event-worker \
  /tmp/output.json && cat /tmp/output.json"
```

**View CloudWatch Logs:**
```bash
# Scheduler logs
docker exec bday-localstack sh -c "awslocal logs tail /aws/lambda/event-scheduler --follow"

# Worker logs
docker exec bday-localstack sh -c "awslocal logs tail /aws/lambda/event-worker --follow"
```

**Check EventBridge targets:**
```bash
docker exec bday-localstack sh -c "awslocal events list-targets-by-rule --rule event-scheduler-rule"
```

**Check SQS event source mappings:**
```bash
docker exec bday-localstack sh -c "awslocal lambda list-event-source-mappings --function-name event-worker"
```

---

## Testing

### Manual Testing Workflow

1. **Start LocalStack:**
   ```bash
   npm run docker:start
   ```

2. **Build and Deploy Lambdas:**
   ```bash
   npm run lambda:all
   ```

3. **Verify Deployment:**
   ```bash
   npm run lambda:verify
   ```

4. **View in LocalStack Desktop:**
   - Open LocalStack Desktop
   - Navigate to Lambda section
   - Verify `event-scheduler` and `event-worker` exist
   - Check configuration and environment variables

5. **Monitor Automatic Execution:**
   - EventBridge triggers scheduler every 1 minute
   - View logs in CloudWatch Logs section of Desktop
   - Or use CLI: `docker exec bday-localstack sh -c "awslocal logs tail /aws/lambda/event-scheduler --follow"`

6. **Send Test SQS Message:**
   ```bash
   docker exec bday-localstack sh -c "awslocal sqs send-message \
     --queue-url http://sqs.us-east-1.localhost.localstack.cloud:4566/000000000000/bday-events-queue \
     --message-body '{\"eventId\":\"test-123\",\"eventType\":\"BIRTHDAY\"}'"
   ```

7. **Verify Worker Processes Message:**
   - Check CloudWatch Logs for worker execution
   - Or view in LocalStack Desktop → CloudWatch Logs → /aws/lambda/event-worker

### Automated Testing

Existing E2E tests will verify Lambda deployment:

```bash
# Run scheduler E2E test
npm test -- schedulerHandler.e2e.test.ts

# Run full E2E test (Story 2.10)
npm test -- event-scheduling-flow.e2e.test.ts
```

---

## Troubleshooting

### Build Fails

**Symptom:** `npm run lambda:build` fails

**Solutions:**
1. Check esbuild is installed: `npm install`
2. Verify handler files exist:
   - `src/adapters/primary/lambda/schedulerHandler.ts`
   - `src/adapters/primary/lambda/workerHandler.ts`
3. Check Prisma client generated: `npm run prisma:generate`

### Deploy Fails

**Symptom:** `npm run lambda:deploy:localstack` fails

**Solutions:**
1. Verify LocalStack is running: `docker ps | grep localstack`
2. Check health: `curl http://localhost:4566/_localstack/health`
3. Verify SQS queue exists: `npm run docker:verify`
4. Check zip files exist: `ls -lh dist/*.zip`

### Verification Fails

**Symptom:** `npm run lambda:verify` shows failures

**Solutions:**
1. Rebuild and redeploy:
   ```bash
   npm run lambda:all
   ```

2. Check specific failures:
   - Lambda not found: Redeploy
   - Environment variables missing: Check `scripts/deploy-lambda.js`
   - EventBridge target missing: Re-run deploy script
   - SQS mapping missing: Re-run deploy script

3. Check LocalStack logs:
   ```bash
   npm run docker:logs
   ```

### Lambda Execution Errors

**Symptom:** Lambda invokes but throws errors

**Possible causes:**
1. **Database connection errors:**
   - Check DATABASE_URL uses `host.docker.internal`
   - Verify PostgreSQL is running: `docker ps | grep postgres`
   - Test connection from Lambda container

2. **Missing Prisma client:**
   - Rebuild Lambdas: `npm run lambda:build`
   - Verify Prisma files copied to zip

3. **Invalid event payload:**
   - Check EventBridge event format
   - Check SQS message format

### CloudWatch Logs Not Appearing

**Symptom:** No logs in CloudWatch

**Solutions:**
1. Invoke Lambda manually to trigger log creation
2. Check log groups exist:
   ```bash
   docker exec bday-localstack sh -c "awslocal logs describe-log-groups"
   ```

3. View recent logs:
   ```bash
   docker exec bday-localstack sh -c "awslocal logs tail /aws/lambda/event-scheduler --since 10m"
   ```

---

## Definition of Done

- [x] Build script runs successfully and creates zip packages
- [x] Deploy script deploys both Lambdas to LocalStack
- [x] EventBridge rule connected to scheduler Lambda
- [x] SQS event source mapping connected to worker Lambda
- [x] Environment variables configured for both Lambdas
- [x] Verification script confirms all configuration
- [x] NPM scripts tested: `lambda:build`, `lambda:deploy:localstack`, `lambda:verify`, `lambda:all`
- [x] Lambdas visible in LocalStack Desktop
- [x] Manual invocation tested
- [x] Story marked as "Complete"

---

## Dev Agent Record

### Agent Model Used
- **Model:** Claude Sonnet 4.5
- **Timestamp:** 2025-10-27

### Debug Log References
- N/A (Using existing build/deploy scripts, added verification only)

### Completion Notes
- ✅ Verified existing build script works correctly
- ✅ Verified existing deploy script works correctly
- ✅ Created comprehensive verification script (11 checks)
- ✅ Added `npm run lambda:verify` to package.json
- ✅ Tested full deployment flow end-to-end
- ✅ Verified Lambdas visible in LocalStack Desktop
- ✅ All 11 verification checks passing

**Build Output:**
- Scheduler package: 45MB
- Worker package: 44MB
- Build time: ~5 seconds

**Deploy Output:**
- Both Lambdas deployed successfully
- EventBridge target configured
- SQS event source mapping created
- All environment variables set

**Verification Results:**
```
✓ Scheduler Lambda function exists
✓ Worker Lambda function exists
✓ EventBridge rule exists
✓ EventBridge rule has targets configured
✓ SQS event source mapping configured for worker
✓ DATABASE_URL configured (scheduler)
✓ SQS_QUEUE_URL configured (scheduler)
✓ DATABASE_URL configured (worker)
✓ WEBHOOK_TEST_URL configured (worker)
✓ Scheduler runtime: nodejs20.x
✓ Worker runtime: nodejs20.x

All checks passed! (11/11)
```

### File List

**Created:**
- `scripts/verify-lambda-deployment.sh` - Comprehensive verification script (11 checks)
- `docs/stories/4.4.lambda-deployment-localstack.story.md` - Story file

**Modified:**
- `package.json` - Added `lambda:verify` script

**Existing (Verified Working):**
- `scripts/lambda-build.sh` - Builds Lambda packages
- `scripts/deploy-lambda.js` - Deploys to LocalStack
- `src/adapters/primary/lambda/schedulerHandler.ts` - Scheduler handler
- `src/adapters/primary/lambda/workerHandler.ts` - Worker handler

### Change Log
- 2025-10-27: Created verification script for Lambda deployment
- 2025-10-27: Added `npm run lambda:verify` to package.json
- 2025-10-27: Tested full build/deploy/verify workflow
- 2025-10-27: Verified all 11 checks passing
- 2025-10-27: Created story documentation

---

## References

- **PRD:** [Epic 4 - End-to-End Testing](../prd/epic-4-end-to-end-testing.md)
- **Story 2.8:** Scheduler Lambda Handler Implementation
- **Story 2.9:** Worker Lambda Handler Implementation
- **Story 4.1:** LocalStack Setup (Community Edition)
- **Story 4.3:** LocalStack Desktop Setup
- **Build Script:** [scripts/lambda-build.sh](../../scripts/lambda-build.sh)
- **Deploy Script:** [scripts/deploy-lambda.js](../../scripts/deploy-lambda.js)
- **Verify Script:** [scripts/verify-lambda-deployment.sh](../../scripts/verify-lambda-deployment.sh)

---

**Created:** 2025-10-27
**Last Updated:** 2025-10-27
