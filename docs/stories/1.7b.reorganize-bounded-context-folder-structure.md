# Story 1.7b: Reorganize to Bounded Context Folder Structure

---

## Status

Ready

---

## Story

**As a** developer,
**I want** the codebase organized by bounded contexts (User, Event Scheduling),
**so that** context boundaries are physically enforced and the codebase is ready for future microservice extraction.

---

## Acceptance Criteria

1. New folder structure created following bounded context pattern:
   ```
   src/
   ├── modules/
   │   ├── user/                           # User Context
   │   │   ├── domain/
   │   │   │   ├── entities/User.ts
   │   │   │   └── value-objects/DateOfBirth.ts
   │   │   ├── application/
   │   │   │   ├── ports/IUserRepository.ts
   │   │   │   └── use-cases/CreateUserUseCase.ts
   │   │   └── adapters/
   │   │       └── persistence/PrismaUserRepository.ts
   │   │
   │   └── event-scheduling/               # Event Scheduling Context
   │       ├── domain/
   │       │   ├── entities/Event.ts
   │       │   ├── value-objects/EventStatus.ts
   │       │   └── services/EventHandlerRegistry.ts
   │       ├── application/
   │       │   └── ports/IEventRepository.ts
   │       └── adapters/
   │           └── persistence/PrismaEventRepository.ts
   │
   ├── shared/                              # Shared Kernel
   │   ├── events/                          # Domain event bus (Story 1.8)
   │   ├── validation/schemas.ts
   │   └── utils/
   │
   └── __tests__/
       └── integration/helpers/
   ```

2. All User Context files moved to `src/modules/user/`:
   - Domain: User entity, DateOfBirth value object
   - Application: IUserRepository port, CreateUserUseCase
   - Adapters: PrismaUserRepository

3. All Event Scheduling Context files moved to `src/modules/event-scheduling/`:
   - Domain: Event entity, EventStatus/IdempotencyKey value objects, EventHandlerRegistry, TimezoneService
   - Application: IEventRepository port
   - Adapters: PrismaEventRepository

4. Shared files moved to `src/shared/`:
   - Timezone value object (used by both contexts)
   - Validation schemas
   - Test helpers

5. All import paths updated across codebase:
   - Use relative imports within same module
   - Use absolute imports with path aliases for cross-module references
   - Example: `@modules/user/domain/entities/User`

6. TypeScript path aliases configured in `tsconfig.json`:
   ```json
   {
     "compilerOptions": {
       "paths": {
         "@modules/*": ["src/modules/*"],
         "@shared/*": ["src/shared/*"]
       }
     }
   }
   ```

7. All existing tests pass with 0 failures after reorganization

8. ESLint and TypeScript compilation succeed with 0 errors

9. Prisma imports remain functional (schemas stay in `prisma/`)

10. No behavioral changes - pure refactoring for structure only

---

## Tasks / Subtasks

- [ ] **Task 1: Create new folder structure** (AC: 1)
  - [ ] Create `src/modules/user/domain/entities/`
  - [ ] Create `src/modules/user/domain/value-objects/`
  - [ ] Create `src/modules/user/application/ports/`
  - [ ] Create `src/modules/user/application/use-cases/`
  - [ ] Create `src/modules/user/adapters/persistence/`
  - [ ] Create `src/modules/event-scheduling/domain/entities/`
  - [ ] Create `src/modules/event-scheduling/domain/value-objects/`
  - [ ] Create `src/modules/event-scheduling/domain/services/`
  - [ ] Create `src/modules/event-scheduling/application/ports/`
  - [ ] Create `src/modules/event-scheduling/adapters/persistence/`
  - [ ] Create `src/shared/value-objects/`
  - [ ] Create `src/shared/validation/`
  - [ ] Keep `src/__tests__/integration/helpers/` (shared test utilities)

- [ ] **Task 2: Move User Context files** (AC: 2)
  - [ ] Move `src/domain/entities/User.ts` → `src/modules/user/domain/entities/User.ts`
  - [ ] Move `src/domain/entities/User.test.ts` → `src/modules/user/domain/entities/User.test.ts`
  - [ ] Move `src/domain/value-objects/DateOfBirth.ts` → `src/modules/user/domain/value-objects/DateOfBirth.ts`
  - [ ] Move `src/domain/value-objects/DateOfBirth.test.ts` → `src/modules/user/domain/value-objects/DateOfBirth.test.ts`
  - [ ] Move `src/application/ports/IUserRepository.ts` → `src/modules/user/application/ports/IUserRepository.ts`
  - [ ] Move `src/application/ports/IUserRepository.test.ts` → `src/modules/user/application/ports/IUserRepository.test.ts`
  - [ ] Move `src/application/use-cases/user/CreateUserUseCase.ts` → `src/modules/user/application/use-cases/CreateUserUseCase.ts`
  - [ ] Move `src/application/use-cases/user/CreateUserUseCase.test.ts` → `src/modules/user/application/use-cases/CreateUserUseCase.test.ts`
  - [ ] Move `src/adapters/secondary/persistence/PrismaUserRepository.ts` → `src/modules/user/adapters/persistence/PrismaUserRepository.ts`
  - [ ] Move `src/adapters/secondary/persistence/PrismaUserRepository.integration.test.ts` → `src/modules/user/adapters/persistence/PrismaUserRepository.integration.test.ts`
  - [ ] Move `src/adapters/secondary/persistence/mappers/userMapper.ts` → `src/modules/user/adapters/persistence/mappers/userMapper.ts`

- [ ] **Task 3: Move Event Scheduling Context files** (AC: 3)
  - [ ] Move `src/domain/entities/Event.ts` → `src/modules/event-scheduling/domain/entities/Event.ts`
  - [ ] Move `src/domain/entities/Event.test.ts` → `src/modules/event-scheduling/domain/entities/Event.test.ts`
  - [ ] Move `src/domain/value-objects/EventStatus.ts` → `src/modules/event-scheduling/domain/value-objects/EventStatus.ts`
  - [ ] Move `src/domain/value-objects/EventStatus.test.ts` → `src/modules/event-scheduling/domain/value-objects/EventStatus.test.ts`
  - [ ] Move `src/domain/value-objects/IdempotencyKey.ts` → `src/modules/event-scheduling/domain/value-objects/IdempotencyKey.ts`
  - [ ] Move `src/domain/value-objects/IdempotencyKey.test.ts` → `src/modules/event-scheduling/domain/value-objects/IdempotencyKey.test.ts`
  - [ ] Move `src/domain/services/EventHandlerRegistry.ts` → `src/modules/event-scheduling/domain/services/EventHandlerRegistry.ts`
  - [ ] Move `src/domain/services/EventHandlerRegistry.test.ts` → `src/modules/event-scheduling/domain/services/EventHandlerRegistry.test.ts`
  - [ ] Move `src/domain/services/TimezoneService.ts` → `src/modules/event-scheduling/domain/services/TimezoneService.ts`
  - [ ] Move `src/domain/services/TimezoneService.test.ts` → `src/modules/event-scheduling/domain/services/TimezoneService.test.ts`
  - [ ] Move `src/domain/services/event-handlers/` → `src/modules/event-scheduling/domain/services/event-handlers/`
  - [ ] Move `src/application/ports/IEventRepository.ts` → `src/modules/event-scheduling/application/ports/IEventRepository.ts`
  - [ ] Move `src/application/ports/IEventRepository.test.ts` → `src/modules/event-scheduling/application/ports/IEventRepository.test.ts`
  - [ ] Move `src/adapters/secondary/persistence/PrismaEventRepository.ts` → `src/modules/event-scheduling/adapters/persistence/PrismaEventRepository.ts`
  - [ ] Move `src/adapters/secondary/persistence/PrismaEventRepository.integration.test.ts` → `src/modules/event-scheduling/adapters/persistence/PrismaEventRepository.integration.test.ts`
  - [ ] Move `src/adapters/secondary/persistence/mappers/eventMapper.ts` → `src/modules/event-scheduling/adapters/persistence/mappers/eventMapper.ts`

- [ ] **Task 4: Move Shared Kernel files** (AC: 4)
  - [ ] Move `src/domain/value-objects/Timezone.ts` → `src/shared/value-objects/Timezone.ts`
  - [ ] Move `src/domain/value-objects/Timezone.test.ts` → `src/shared/value-objects/Timezone.test.ts`
  - [ ] Keep `src/shared/validation/schemas.ts` (already in shared)
  - [ ] Keep `src/__tests__/integration/helpers/testDatabase.ts` (already shared)

- [ ] **Task 5: Configure TypeScript path aliases** (AC: 6)
  - [ ] Update `tsconfig.json` with path mappings:
    ```json
    {
      "compilerOptions": {
        "baseUrl": ".",
        "paths": {
          "@modules/user/*": ["src/modules/user/*"],
          "@modules/event-scheduling/*": ["src/modules/event-scheduling/*"],
          "@shared/*": ["src/shared/*"]
        }
      }
    }
    ```
  - [ ] Update `tsconfig.test.json` to inherit path mappings
  - [ ] Verify VS Code recognizes path aliases (IntelliSense autocomplete)

- [ ] **Task 6: Update all import paths** (AC: 5)
  - [ ] Update imports in User Context files:
    - Use relative imports within `src/modules/user/`
    - Use `@shared/*` for Timezone value object
    - Use `@modules/event-scheduling/*` for Event dependencies (will be removed in Story 1.10)
  - [ ] Update imports in Event Scheduling Context files:
    - Use relative imports within `src/modules/event-scheduling/`
    - Use `@shared/*` for Timezone value object
  - [ ] Update imports in test files
  - [ ] Update imports in Prisma repositories
  - [ ] Update imports in `src/index.ts` (entry point)

- [ ] **Task 7: Run tests and fix any issues** (AC: 7, 8)
  - [ ] Run `npm test` and verify all tests pass
  - [ ] Run `npx eslint src/` and fix any errors
  - [ ] Run `npx tsc --noEmit` and fix any type errors
  - [ ] Verify Prisma imports work correctly
  - [ ] Run integration tests with test database

- [ ] **Task 8: Clean up old folders** (AC: 10)
  - [ ] Delete empty `src/domain/` folder
  - [ ] Delete empty `src/application/` folder
  - [ ] Delete empty `src/adapters/` folder
  - [ ] Verify no orphaned files left behind

- [ ] **Task 9: Update documentation references** (AC: 10)
  - [ ] Update `docs/architecture/bounded-contexts.md` to reflect actual folder structure
  - [ ] Update `docs/architecture/source-tree.md` with new folder structure
  - [ ] Update Story 1.8, 1.9, 1.10 file paths to match new structure

---

## Dev Notes

This story implements **physical separation** of bounded contexts to match the **logical separation** established in architecture documentation. This is a pure refactoring story - no behavioral changes.

### Architecture Context

**[Source: architecture/bounded-contexts.md]**

This reorganization enforces bounded context boundaries at the filesystem level:

- **User Context:** `src/modules/user/` - Owns User aggregate, DateOfBirth value object
- **Event Scheduling Context:** `src/modules/event-scheduling/` - Owns Event aggregate, EventStatus, IdempotencyKey
- **Shared Kernel:** `src/shared/` - Timezone value object (used by both contexts)

### Why Reorganize Now?

**[Source: User decision]**

> "I rather reorganise now than later which will be very hard"

**Benefits of Early Reorganization:**

1. **Prevents Accidental Coupling:** Folder structure enforces context boundaries
2. **Easier Code Reviews:** Violations of bounded context rules are visible (wrong folder)
3. **Microservice Extraction Ready:** Each `src/modules/*` can become a separate repo
4. **Developer Onboarding:** New developers understand domain boundaries immediately
5. **Tooling Support:** IDEs can enforce import rules by folder

**Risk if Postponed:**

- At 10K+ lines of code, reorganization becomes risky (merge conflicts, missed imports)
- Current codebase: ~53 TypeScript files - manageable refactoring
- Future codebase (after Epic 2-5): ~200+ files - high-risk refactoring

---

### Migration Strategy: Git Moves Preserve History

**Use `git mv` instead of file system moves:**

```bash
# ✅ CORRECT: Preserves git history
git mv src/domain/entities/User.ts src/modules/user/domain/entities/User.ts

# ❌ WRONG: Loses git history (appears as delete + create)
mv src/domain/entities/User.ts src/modules/user/domain/entities/User.ts
git add .
```

**Why Preserve History?**
- Future developers can use `git log --follow` to trace file evolution
- `git blame` continues to work across renames
- Code archaeology remains functional

---

### Import Path Strategy

**Within Same Module (Relative Imports):**

```typescript
// ✅ src/modules/user/application/use-cases/CreateUserUseCase.ts
import { User } from '../../domain/entities/User';
import { IUserRepository } from '../ports/IUserRepository';
```

**Across Modules (Path Aliases):**

```typescript
// ✅ src/modules/user/application/use-cases/CreateUserUseCase.ts
import { Timezone } from '@shared/value-objects/Timezone';
import { IEventRepository } from '@modules/event-scheduling/application/ports/IEventRepository'; // ⚠️ Will be removed in Story 1.10
```

**Rationale:**
- Relative imports: Short, clear context boundaries
- Path aliases: Avoid `../../../../` hell, refactoring-friendly

---

### TypeScript Path Alias Configuration

**tsconfig.json:**

```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@modules/user/*": ["src/modules/user/*"],
      "@modules/event-scheduling/*": ["src/modules/event-scheduling/*"],
      "@shared/*": ["src/shared/*"]
    }
  }
}
```

**Why Path Aliases?**

1. **Refactoring Safety:** If we move a file, only update tsconfig, not every import
2. **Readability:** `@modules/user/domain/entities/User` is clearer than `../../../../domain/entities/User`
3. **Microservice Extraction:** Change `@modules/user/*` to npm package later

---

### Testing Strategy

**Verify No Behavioral Changes:**

1. **Unit Tests:** All existing tests must pass without modification (except import paths)
2. **Integration Tests:** Database interactions remain identical
3. **TypeScript Compilation:** No new type errors introduced
4. **ESLint:** No new linting errors introduced

**Test Execution Order:**

```bash
# 1. Move files
git mv src/domain/entities/User.ts src/modules/user/domain/entities/User.ts

# 2. Update imports
# (Update all import statements in moved file)

# 3. Test incrementally
npm test -- src/modules/user/domain/entities/User.test.ts

# 4. Repeat for all files

# 5. Full test suite
npm test
```

---

### Potential Issues and Solutions

**Issue 1: Circular Dependencies Exposed**

```typescript
// ❌ Problem: User imports Event, Event imports User
// src/modules/user/domain/entities/User.ts
import { Event } from '@modules/event-scheduling/domain/entities/Event';

// src/modules/event-scheduling/domain/entities/Event.ts
import { User } from '@modules/user/domain/entities/User';
```

**Solution:** Domain events break the cycle (implemented in Story 1.8-1.10)

**Issue 2: Prisma Generated Code Imports**

```typescript
// Prisma schema imports still use old paths
import { EventStatus } from '@prisma/client';
```

**Solution:** Prisma imports are NOT affected (generated code stays in node_modules)

**Issue 3: Test Helpers Import Paths**

```typescript
// src/__tests__/integration/helpers/testDatabase.ts
// May import from both User and Event contexts
```

**Solution:** Test helpers remain in `src/__tests__/` (shared across contexts)

---

## Dependencies

- **Depends on:** Story 1.7 (Prisma Repository Implementations) - must be complete first
- **Blocks:** Story 1.8 (Domain Event Bus) - event bus will be created in new `src/shared/events/` structure

---

## Effort Estimate

**6-8 hours**

- Task 1 (Create folders): 30 minutes
- Task 2-4 (Move files): 2 hours (53 files × 2 minutes each)
- Task 5 (Path aliases): 30 minutes
- Task 6 (Update imports): 3 hours (careful path updates, verify each file)
- Task 7 (Testing): 1 hour (run tests, fix issues)
- Task 8-9 (Cleanup): 1 hour

---

## Definition of Done

- [ ] All User Context files moved to `src/modules/user/`
- [ ] All Event Scheduling Context files moved to `src/modules/event-scheduling/`
- [ ] All Shared Kernel files moved to `src/shared/`
- [ ] TypeScript path aliases configured in `tsconfig.json`
- [ ] All import paths updated (no broken imports)
- [ ] All tests pass (`npm test`)
- [ ] ESLint passes with 0 errors (`npx eslint src/`)
- [ ] TypeScript compilation succeeds (`npx tsc --noEmit`)
- [ ] Git history preserved (used `git mv`)
- [ ] Old folders deleted (no orphaned files)
- [ ] Documentation updated to reflect new structure
- [ ] Code reviewed and approved

---

## References

- **Architecture Decision:** [Bounded Contexts - Folder Structure](../architecture/bounded-contexts.md#folder-structure-logical-vs-physical-separation)
- **Source Tree Documentation:** [Project Structure](../architecture/source-tree.md)
- **User Decision:** "I rather reorganise now than later which will be very hard"
