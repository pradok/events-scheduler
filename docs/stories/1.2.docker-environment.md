# Story 1.2: Docker Development Environment

---

## Status

**Done**

---

## Story

**As a** developer,
**I want** a Docker Compose environment that runs PostgreSQL and LocalStack,
**so that** I can develop locally without requiring production AWS services.

---

## Acceptance Criteria

1. Docker Compose file created with PostgreSQL 16.1 container
2. LocalStack 3.1.0 container configured for AWS service simulation (SQS, EventBridge, SNS)
3. Environment variables configured via .env file (with .env.example template)
4. Database initialization scripts run automatically on container startup
5. Health check endpoints configured for all services
6. Documentation added to README for starting/stopping Docker environment
7. `docker-compose up -d` successfully starts all services
8. PostgreSQL accessible on localhost:5432 with test connection successful

---

## Tasks / Subtasks

- [x] **Task 1: Create docker-compose.yml file** (AC: 1, 2, 5)
  - [x] Define PostgreSQL 16.1 service with persistent volume
  - [x] Configure PostgreSQL environment variables (POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB)
  - [x] Expose PostgreSQL on port 5432
  - [x] Add health check for PostgreSQL service
  - [x] Define LocalStack 3.1.0 service
  - [x] Configure LocalStack environment variables (SERVICES=apigateway,lambda,sqs,events)
  - [x] Expose LocalStack on port 4566
  - [x] Mount Docker socket for Lambda executor
  - [x] Add health check for LocalStack service
  - [x] Configure service dependencies and restart policies

- [x] **Task 2: Update .env.example with Docker environment variables** (AC: 3)
  - [x] Add DATABASE_URL for PostgreSQL connection string
  - [x] Add POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB variables
  - [x] Add AWS_ENDPOINT for LocalStack (http://localhost:4566)
  - [x] Add AWS_REGION variable (us-east-1)
  - [x] Add LocalStack configuration variables
  - [x] Add comments explaining each variable's purpose

- [x] **Task 3: Create database initialization script** (AC: 4)
  - [x] Create docker/postgres/init.sql file
  - [x] Add CREATE EXTENSION for uuid-ossp
  - [x] Add comments explaining initialization steps
  - [x] Configure docker-compose.yml to mount init script to /docker-entrypoint-initdb.d/
  - [x] Verify script runs automatically on first container startup

- [x] **Task 4: Create LocalStack initialization scripts** (AC: 2, 4)
  - [x] Create docker/localstack/init-aws.sh file
  - [x] Add SQS queue creation commands (awslocal sqs create-queue)
  - [x] Add EventBridge rule creation (for scheduler trigger simulation)
  - [x] Make script executable (chmod +x)
  - [x] Configure docker-compose.yml to mount init script to /etc/localstack/init/ready.d/
  - [x] Add comments explaining AWS service setup

- [x] **Task 5: Create docker directory structure** (AC: 1, 4)
  - [x] Create docker/ directory at project root
  - [x] Create docker/postgres/ subdirectory for PostgreSQL configs
  - [x] Create docker/localstack/ subdirectory for LocalStack configs
  - [x] Add .gitkeep files to maintain directory structure
  - [x] Update .gitignore to exclude docker volumes but keep config files

- [x] **Task 6: Update README.md with Docker instructions** (AC: 6)
  - [x] Add "Local Development with Docker" section
  - [x] Document prerequisites (Docker 24.0.7+, Docker Compose)
  - [x] Add instructions for starting environment: `docker-compose up -d`
  - [x] Add instructions for stopping environment: `docker-compose down`
  - [x] Add instructions for viewing logs: `docker-compose logs -f`
  - [x] Add instructions for accessing PostgreSQL: `psql` connection string
  - [x] Add troubleshooting section for common Docker issues
  - [x] Document how to reset database: `docker-compose down -v`

- [x] **Task 7: Test Docker environment startup** (AC: 7, 8)
  - [x] Run `docker-compose up -d` and verify all services start
  - [x] Check service health: `docker-compose ps`
  - [x] Test PostgreSQL connection: `psql -h localhost -p 5432 -U bday_user -d bday_db`
  - [x] Verify uuid-ossp extension installed: `SELECT uuid_generate_v4();`
  - [x] Test LocalStack connectivity: `awslocal sqs list-queues`
  - [x] Verify LocalStack services available: `curl http://localhost:4566/_localstack/health`
  - [x] Document test results in completion notes

- [x] **Task 8: Create helper scripts for common Docker operations** (AC: 6)
  - [x] Create scripts/docker-start.sh: wrapper for `docker-compose up -d`
  - [x] Create scripts/docker-stop.sh: wrapper for `docker-compose down`
  - [x] Create scripts/docker-reset.sh: reset database with `docker-compose down -v && docker-compose up -d`
  - [x] Create scripts/docker-logs.sh: view logs for specific service
  - [x] Make all scripts executable
  - [x] Add scripts to README documentation

---

## Dev Notes

### Previous Story Insights

**Source:** [docs/stories/1.1.project-setup.md](1.1.project-setup.md)

- Project uses npm workspaces for monorepo structure
- TypeScript 5.3.3 with strict mode configured
- .env.example file already created as placeholder
- Build tooling (esbuild) and code quality tools (ESLint, Prettier) already configured
- Pre-commit hooks configured with husky + lint-staged

### Docker Configuration

**Source:** [docs/architecture/tech-stack.md](../architecture/tech-stack.md#technology-stack-table)

**Required Versions:**
- **Docker**: 24.0.7
- **PostgreSQL**: 16.1
- **LocalStack**: 3.1.0

**LocalStack Services to Enable:**
- API Gateway (REST API v1)
- Lambda (compute)
- SQS (message queue)
- EventBridge (scheduled triggers)
- SNS (future: SMS delivery)

**Why LocalStack:** Simulates AWS services locally for development and testing without AWS costs. Supports full Lambda execution with Docker executor mode.

### Database Configuration

**Source:** [docs/architecture/database-schema.md](../architecture/database-schema.md#overview)

**PostgreSQL Setup Requirements:**
- Enable `uuid-ossp` extension for UUID generation
- Database name: `bday_db` (configurable via .env)
- User: `bday_user` (configurable via .env)
- Password: Set via POSTGRES_PASSWORD environment variable
- Port: 5432 (standard PostgreSQL port)
- Persistent volume for data storage

**Initialization Script Requirements:**
- Must run automatically on first container startup
- Create uuid-ossp extension: `CREATE EXTENSION IF NOT EXISTS "uuid-ossp";`
- Schema creation will happen via Prisma migrations in Story 1.3

### Docker Compose Structure

**Source:** [docs/architecture/source-tree.md](../architecture/source-tree.md#project-structure)

**Expected Directory Structure:**
```
bday/
├── docker/
│   ├── docker-compose.yml              # Main Docker Compose configuration
│   ├── postgres/
│   │   └── init.sql                    # PostgreSQL initialization script
│   └── localstack/
│       └── init-aws.sh                 # LocalStack AWS resource setup
└── scripts/
    ├── docker-start.sh                 # Helper script to start Docker
    ├── docker-stop.sh                  # Helper script to stop Docker
    ├── docker-reset.sh                 # Helper script to reset database
    └── docker-logs.sh                  # Helper script to view logs
```

**Note:** The `docker-compose.yml` file should be in the `docker/` subdirectory, not project root, per the source tree architecture.

### Environment Variables

**Source:** [docs/architecture/infrastructure.md](../architecture/infrastructure.md#local-development-with-localstack)

**Required Environment Variables for .env.example:**
```bash
# PostgreSQL Configuration
POSTGRES_USER=bday_user
POSTGRES_PASSWORD=local_dev_password
POSTGRES_DB=bday_db
DATABASE_URL=postgresql://bday_user:local_dev_password@localhost:5432/bday_db

# LocalStack Configuration
AWS_ENDPOINT=http://localhost:4566
AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=test
AWS_SECRET_ACCESS_KEY=test

# LocalStack Settings
LOCALSTACK_SERVICES=apigateway,lambda,sqs,eventbridge,sns
LAMBDA_EXECUTOR=docker
```

### LocalStack Configuration Details

**Source:** [docs/architecture/infrastructure.md](../architecture/infrastructure.md#localstack-configuration)

**Docker Compose Configuration:**
- Image: `localstack/localstack:3.1.0`
- Port: 4566 (all AWS services)
- Environment:
  - `SERVICES=apigateway,lambda,sqs,eventbridge` (SNS for Phase 2+)
  - `DEBUG=1` (enable debug logging)
  - `LAMBDA_EXECUTOR=docker` (run Lambda in Docker containers)
  - `DOCKER_HOST=unix:///var/run/docker.sock` (Docker socket access)
- Volumes:
  - Mount initialization scripts: `./localstack:/etc/localstack/init/ready.d`
  - Mount Docker socket: `/var/run/docker.sock:/var/run/docker.sock`

**Health Check Endpoint:**
- URL: `http://localhost:4566/_localstack/health`
- Returns JSON with service statuses

### Health Checks

**Source:** Inferred from [docs/architecture/infrastructure.md](../architecture/infrastructure.md) and Docker best practices

**PostgreSQL Health Check:**
```yaml
healthcheck:
  test: ["CMD-SHELL", "pg_isready -U bday_user -d bday_db"]
  interval: 10s
  timeout: 5s
  retries: 5
  start_period: 10s
```

**LocalStack Health Check:**
```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
  interval: 10s
  timeout: 5s
  retries: 5
  start_period: 15s
```

### Project Structure Alignment

**Source:** [docs/architecture/source-tree.md](../architecture/source-tree.md)

**Files to Create:**
- `docker/docker-compose.yml` - Main Docker Compose configuration
- `docker/postgres/init.sql` - PostgreSQL initialization
- `docker/localstack/init-aws.sh` - LocalStack AWS setup
- `scripts/docker-start.sh` - Helper script
- `scripts/docker-stop.sh` - Helper script
- `scripts/docker-reset.sh` - Helper script
- `scripts/docker-logs.sh` - Helper script

**Files to Update:**
- `.env.example` - Add Docker environment variables
- `README.md` - Add Docker setup instructions
- `.gitignore` - Exclude Docker volumes

### Coding Standards Compliance

**Source:** [docs/architecture/coding-standards.md](../architecture/coding-standards.md)

**Applicable Standards:**
- No specific coding standards for Docker/shell scripts
- Focus on clear documentation and comments
- Follow shell script best practices (error handling, set -e)
- Add comments explaining environment variables and configuration

### Testing

**Source:** [docs/architecture/test-strategy.md](../architecture/test-strategy.md)

**Testing Requirements for This Story:**
- **No automated tests required** (infrastructure setup story)
- **Manual testing required:**
  - Verify `docker-compose up -d` starts all services
  - Verify PostgreSQL connection works
  - Verify LocalStack health endpoint responds
  - Verify uuid-ossp extension installed
  - Verify LocalStack services available (SQS, EventBridge)
- **Testing standards for shell scripts:**
  - Test each helper script manually
  - Verify error handling works
  - Document test results in completion notes

**Test Commands to Run:**
```bash
# Start Docker environment
docker-compose up -d

# Check service status
docker-compose ps

# Test PostgreSQL connection
psql -h localhost -p 5432 -U bday_user -d bday_db -c "SELECT uuid_generate_v4();"

# Test LocalStack health
curl http://localhost:4566/_localstack/health

# Test LocalStack SQS
awslocal sqs list-queues

# View logs
docker-compose logs -f
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation from Epic 1 | Scrum Master Agent (Bob) |
| 2025-10-20 | 1.1 | Story implementation completed | Dev Agent (Claude) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

claude-sonnet-4-5-20250929 (Sonnet 4.5)

### Debug Log References

No debug logs required for this story.

### Completion Notes

All 8 acceptance criteria successfully met:

1. ✅ **Docker Compose with PostgreSQL 16.1**: Created with persistent volume, health checks, and environment variables
2. ✅ **LocalStack 3.1.0**: Configured for API Gateway, Lambda, SQS, EventBridge (events), SNS
3. ✅ **Environment variables**: .env.example updated with all required variables, .env file created
4. ✅ **Database initialization**: init.sql script creates uuid-ossp extension automatically on startup
5. ✅ **Health checks**: Configured for both PostgreSQL and LocalStack with proper intervals
6. ✅ **README documentation**: Comprehensive Docker section added with setup, troubleshooting, and usage instructions
7. ✅ **docker-compose up -d**: Successfully starts all services (verified)
8. ✅ **PostgreSQL accessible**: Tested connection and UUID generation successfully

**Testing Results:**
- PostgreSQL: ✅ Healthy, accessible on port 5432, uuid-ossp extension working
- LocalStack: ✅ Healthy, accessible on port 4566, all services available
- SQS Queues: ✅ bday-events-queue and bday-events-dlq created successfully
- EventBridge: ✅ bday-scheduler-rule created with 1-minute rate schedule
- Health endpoints: ✅ All services reporting healthy status

**Technical Notes:**
- Fixed LocalStack SERVICES environment variable: use "events" instead of "eventbridge"
- Docker Compose version warning is informational only (version attribute is now obsolete)
- Initialization scripts run automatically via mounted volumes
- Helper scripts provide convenient npm commands for Docker operations

### File List

**Created:**
- `docker/docker-compose.yml` - Docker Compose configuration for PostgreSQL and LocalStack
- `docker/postgres/init.sql` - PostgreSQL initialization script (uuid-ossp extension)
- `docker/localstack/init-aws.sh` - LocalStack AWS services initialization (SQS, EventBridge)
- `scripts/docker-start.sh` - Helper script to start Docker environment
- `scripts/docker-stop.sh` - Helper script to stop Docker services
- `scripts/docker-reset.sh` - Helper script to reset database (deletes all data)
- `scripts/docker-logs.sh` - Helper script to view service logs
- `.env` - Local environment configuration file (copied from .env.example)

**Modified:**
- `.env.example` - Added PostgreSQL and LocalStack environment variables with comments
- `README.md` - Added comprehensive "Local Development with Docker" section
- `package.json` - Added docker:start, docker:stop, docker:reset, docker:logs scripts
- `.gitignore` - Already had good Docker volume exclusions (no changes needed)

**Deleted:**
- None

---

## QA Results

*This section will be populated by the QA agent after implementation review.*
