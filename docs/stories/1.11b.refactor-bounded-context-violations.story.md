# Story 1.11b: Refactor Bounded Context Violations

---

## Status

Approved - Ready for Implementation

---

## Context

Story 1.11 was implemented with architectural violations that contradict **bounded-contexts.md**:

**Violations:**
1. `UpdateUserUseCase` directly imports `IEventRepository`, `TimezoneService`, `EventHandlerRegistry` from Event Scheduling context
2. `DeleteUserUseCase` directly imports `IEventRepository` from Event Scheduling context
3. Manual Zod schemas defined instead of using Prisma-generated schemas

**Root Cause:**
- Story 1.11 document (lines 332-334) incorrectly stated direct dependencies were "acceptable"
- bounded-contexts.md was not in devLoadAlwaysFiles (now fixed in commit 13b5409)
- Prisma schema README was missing (now created in commit 13b5409)

**Documentation Now Fixed:**
- ✅ Story 1.11 updated (commit 832c6c1) to mandate event-driven architecture
- ✅ Domain events created: UserBirthdayChanged, UserTimezoneChanged, UserDeleted
- ✅ bounded-contexts.md added to devLoadAlwaysFiles
- ✅ Schema README created documenting Prisma-generated schemas

**Current State:**
- All 210 tests passing (100% success rate)
- Code works correctly BUT violates bounded context principles
- Implementation must be refactored to match corrected architecture

---

## Story

**As a** developer,
**I want** to refactor Story 1.11 implementation to use event-driven architecture,
**so that** User and Event Scheduling contexts maintain proper independence per bounded-contexts.md.

---

## Acceptance Criteria

**Event Handlers (Event Scheduling Context):**

1. RescheduleEventsOnUserBirthdayChangedHandler created and registered with event bus
2. RescheduleEventsOnUserTimezoneChangedHandler created and registered with event bus
3. DeleteEventsOnUserDeletedHandler created and registered with event bus
4. All handlers have 100% unit test coverage

**Use Case Refactoring (User Context):**

5. UpdateUserUseCase constructor has ONLY: IUserRepository, IDomainEventBus (Event Scheduling deps removed)
6. UpdateUserUseCase publishes UserBirthdayChanged event when dateOfBirth changes
7. UpdateUserUseCase publishes UserTimezoneChanged event when timezone changes
8. DeleteUserUseCase constructor has ONLY: IUserRepository, IDomainEventBus (IEventRepository removed)
9. DeleteUserUseCase publishes UserDeleted event after deleting user

**Schema Refactoring:**

10. UpdateUserSchema derived from Prisma-generated User.schema.ts using .pick().partial()
11. UserResponseSchema derived from Prisma-generated User.schema.ts with Date→string transformation
12. Manual schema definitions removed from src/shared/validation/schemas.ts

**Testing:**

13. All 210 existing tests updated and passing
14. Integration tests verify event-driven rescheduling works end-to-end
15. No performance degradation (event handlers execute synchronously)

**Architecture Compliance:**

16. User context has ZERO imports from Event Scheduling context (enforced by bounded-contexts.md)
17. Cross-context communication happens ONLY via domain events
18. TypeScript compilation verifies no cross-context coupling

---

## Tasks / Subtasks

- [ ] **Task 1: Create RescheduleEventsOnUserBirthdayChangedHandler**
  - [ ] Create file `src/modules/event-scheduling/application/event-handlers/RescheduleEventsOnUserBirthdayChangedHandler.ts`
  - [ ] Constructor receives: IEventRepository, TimezoneService, EventHandlerRegistry
  - [ ] Implement `handle(event: UserBirthdayChangedEvent): Promise<void>`
  - [ ] Query PENDING birthday events for user
  - [ ] For each PENDING event:
    - Calculate new next birthday using BirthdayEventHandler.calculateNextOccurrence()
    - Convert to UTC using TimezoneService.convertToUTC()
    - Call Event.reschedule() (immutable, version increment)
    - Save via eventRepository.update()
  - [ ] Do NOT modify PROCESSING/COMPLETED/FAILED events
  - [ ] Follow CreateBirthdayEventOnUserCreatedHandler pattern from Story 1.9

- [ ] **Task 2: Create RescheduleEventsOnUserTimezoneChangedHandler**
  - [ ] Create file `src/modules/event-scheduling/application/event-handlers/RescheduleEventsOnUserTimezoneChangedHandler.ts`
  - [ ] Constructor receives: IEventRepository, TimezoneService
  - [ ] Implement `handle(event: UserTimezoneChangedEvent): Promise<void>`
  - [ ] Query PENDING events for user (all types)
  - [ ] For each PENDING event:
    - Keep targetTimestampLocal unchanged (9:00 AM)
    - Recalculate targetTimestampUTC using new timezone
    - Call Event.reschedule()
    - Save via eventRepository.update()
  - [ ] Do NOT modify PROCESSING/COMPLETED/FAILED events

- [ ] **Task 3: Create DeleteEventsOnUserDeletedHandler**
  - [ ] Create file `src/modules/event-scheduling/application/event-handlers/DeleteEventsOnUserDeletedHandler.ts`
  - [ ] Constructor receives: IEventRepository
  - [ ] Implement `handle(event: UserDeletedEvent): Promise<void>`
  - [ ] Call eventRepository.deleteByUserId(event.userId)
  - [ ] Delete ALL events (PENDING, PROCESSING, COMPLETED, FAILED)

- [ ] **Task 4: Unit test RescheduleEventsOnUserBirthdayChangedHandler**
  - [ ] Create file `RescheduleEventsOnUserBirthdayChangedHandler.test.ts`
  - [ ] Mock IEventRepository, TimezoneService, EventHandlerRegistry
  - [ ] Test: "should reschedule PENDING birthday events when birthday changed"
  - [ ] Test: "should NOT modify COMPLETED events"
  - [ ] Test: "should handle Feb 29 birthday edge case"
  - [ ] Achieve 100% coverage

- [ ] **Task 5: Unit test RescheduleEventsOnUserTimezoneChangedHandler**
  - [ ] Create file `RescheduleEventsOnUserTimezoneChangedHandler.test.ts`
  - [ ] Mock IEventRepository, TimezoneService
  - [ ] Test: "should recalculate UTC times for PENDING events"
  - [ ] Test: "should maintain local time (9:00 AM)"
  - [ ] Test: "should NOT modify COMPLETED events"
  - [ ] Achieve 100% coverage

- [ ] **Task 6: Unit test DeleteEventsOnUserDeletedHandler**
  - [ ] Create file `DeleteEventsOnUserDeletedHandler.test.ts`
  - [ ] Mock IEventRepository
  - [ ] Test: "should delete all events for deleted user"
  - [ ] Test: "should handle user with no events"
  - [ ] Achieve 100% coverage

- [ ] **Task 7: Refactor UpdateUserUseCase to publish domain events**
  - [ ] Remove constructor dependencies: IEventRepository, TimezoneService, EventHandlerRegistry
  - [ ] Add constructor dependency: IDomainEventBus
  - [ ] Remove rescheduleEventsForBirthdayChange() private method
  - [ ] Remove rescheduleEventsForTimezoneChange() private method
  - [ ] Track oldDateOfBirth and oldTimezone BEFORE updating user
  - [ ] After user update, if dateOfBirth changed: publish UserBirthdayChanged event
  - [ ] After user update, if timezone changed: publish UserTimezoneChanged event
  - [ ] Simplify execute() method (no direct event rescheduling logic)

- [ ] **Task 8: Refactor DeleteUserUseCase to publish domain events**
  - [ ] Remove constructor dependency: IEventRepository
  - [ ] Add constructor dependency: IDomainEventBus
  - [ ] After deleting user: publish UserDeleted event
  - [ ] Remove direct eventRepository.deleteByUserId() call
  - [ ] Simplify to: findById → delete → publish event

- [ ] **Task 9: Update UpdateUserUseCase unit tests**
  - [ ] Replace IEventRepository/TimezoneService/EventHandlerRegistry mocks with IDomainEventBus mock
  - [ ] Test: "should publish UserBirthdayChanged event when birthday updated"
  - [ ] Test: "should publish UserTimezoneChanged event when timezone updated"
  - [ ] Test: "should publish both events when both fields updated"
  - [ ] Test: "should NOT publish events when only name updated"
  - [ ] Remove tests for rescheduleEventsForBirthdayChange() (moved to event handler)
  - [ ] Remove tests for rescheduleEventsForTimezoneChange() (moved to event handler)

- [ ] **Task 10: Update DeleteUserUseCase unit tests**
  - [ ] Replace IEventRepository mock with IDomainEventBus mock
  - [ ] Test: "should publish UserDeleted event after deleting user"
  - [ ] Remove test for eventRepository.deleteByUserId() (moved to event handler)

- [ ] **Task 11: Derive UpdateUserSchema from Prisma-generated schema**
  - [ ] Open `src/shared/validation/schemas.ts`
  - [ ] Import UserSchema from `@/domain/schemas/generated/schemas/models/User.schema`
  - [ ] Replace manual UpdateUserSchema with:
    ```typescript
    export const UpdateUserSchema = UserSchema
      .pick({ firstName: true, lastName: true, dateOfBirth: true, timezone: true })
      .partial()
      .extend({
        dateOfBirth: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
      });
    ```
  - [ ] Remove manual field definitions

- [ ] **Task 12: Derive UserResponseSchema from Prisma-generated schema**
  - [ ] Import UserSchema from generated schemas
  - [ ] Replace manual UserResponseSchema with transformation:
    ```typescript
    export const UserResponseSchema = UserSchema.extend({
      dateOfBirth: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
      createdAt: z.string().datetime(),
      updatedAt: z.string().datetime(),
    });
    ```
  - [ ] Verify type inference still works: `type UserResponse = z.infer<typeof UserResponseSchema>`

- [ ] **Task 13: Register event handlers in server startup**
  - [ ] Open `src/adapters/primary/http/server.ts` (or create separate event bus setup file)
  - [ ] Create InMemoryEventBus instance
  - [ ] Register RescheduleEventsOnUserBirthdayChangedHandler for 'UserBirthdayChanged' event
  - [ ] Register RescheduleEventsOnUserTimezoneChangedHandler for 'UserTimezoneChanged' event
  - [ ] Register DeleteEventsOnUserDeletedHandler for 'UserDeleted' event
  - [ ] Pass eventBus to use cases via dependency injection

- [ ] **Task 14: Update integration tests for event-driven architecture**
  - [ ] Update user.routes.integration.test.ts setup to register event handlers
  - [ ] Verify birthday rescheduling integration test passes (currently failing)
  - [ ] Verify timezone rescheduling integration test passes (currently failing)
  - [ ] Verify all 12 integration tests pass

- [ ] **Task 15: Verify architecture compliance**
  - [ ] Run TypeScript compilation: `npx tsc --noEmit`
  - [ ] Verify NO imports from Event Scheduling context in User context files
  - [ ] Check imports in UpdateUserUseCase.ts and DeleteUserUseCase.ts
  - [ ] Confirm only IDomainEventBus and IUserRepository dependencies

- [ ] **Task 16: Run full test suite and verify**
  - [ ] Run `npm test` - all 210+ tests should pass
  - [ ] Run `npx eslint src/` - no linting errors
  - [ ] Verify bounded context separation maintained
  - [ ] Document final test results in story

---

## Technical Notes

### Event Handler Pattern (from Story 1.9)

Follow the existing pattern from CreateBirthdayEventOnUserCreatedHandler:

```typescript
export class RescheduleEventsOnUserBirthdayChangedHandler {
  public constructor(
    private readonly eventRepository: IEventRepository,
    private readonly timezoneService: TimezoneService,
    private readonly eventHandlerRegistry: EventHandlerRegistry
  ) {}

  public async handle(event: UserBirthdayChangedEvent): Promise<void> {
    // Query PENDING birthday events
    const allEvents = await this.eventRepository.findByUserId(event.userId);
    const pendingBirthdayEvents = allEvents.filter(
      (e) => e.status === EventStatus.PENDING && e.eventType === 'BIRTHDAY'
    );

    for (const existingEvent of pendingBirthdayEvents) {
      // Calculate new next birthday
      const handler = this.eventHandlerRegistry.getHandler('BIRTHDAY');
      const user = {
        id: event.userId,
        dateOfBirth: new DateOfBirth(event.newDateOfBirth),
        timezone: new Timezone(event.timezone),
      };
      const nextBirthdayLocal = handler.calculateNextOccurrence(user);
      const nextBirthdayUTC = this.timezoneService.convertToUTC(
        nextBirthdayLocal,
        user.timezone
      );

      // Reschedule event (immutable update with version increment)
      const rescheduledEvent = existingEvent.reschedule(
        nextBirthdayUTC,
        nextBirthdayLocal,
        event.timezone
      );

      await this.eventRepository.update(rescheduledEvent);
    }
  }
}
```

### Rescheduling Logic Ownership

**Before (WRONG):**
- User Context: UpdateUserUseCase contains rescheduling logic
- Violation: User context depends on Event Scheduling context

**After (CORRECT):**
- User Context: UpdateUserUseCase publishes events only
- Event Scheduling Context: Event handlers contain rescheduling logic
- Proper separation: Each context owns its own logic

### Event Bus Registration

```typescript
// In server startup or separate bootstrap file
const eventBus = new InMemoryEventBus();
const eventRepository = new PrismaEventRepository(prisma);
const timezoneService = new TimezoneService();
const eventHandlerRegistry = new EventHandlerRegistry();

// Register handlers
const birthdayChangedHandler = new RescheduleEventsOnUserBirthdayChangedHandler(
  eventRepository,
  timezoneService,
  eventHandlerRegistry
);
eventBus.subscribe('UserBirthdayChanged', (event) => birthdayChangedHandler.handle(event));

const timezoneChangedHandler = new RescheduleEventsOnUserTimezoneChangedHandler(
  eventRepository,
  timezoneService
);
eventBus.subscribe('UserTimezoneChanged', (event) => timezoneChangedHandler.handle(event));

const userDeletedHandler = new DeleteEventsOnUserDeletedHandler(eventRepository);
eventBus.subscribe('UserDeleted', (event) => userDeletedHandler.handle(event));
```

### Prisma Schema Usage

```typescript
// BEFORE (manual duplication - WRONG)
export const UpdateUserSchema = z.object({
  firstName: z.string().min(1).max(100).optional(),
  lastName: z.string().min(1).max(100).optional(),
  dateOfBirth: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
  timezone: z.string().optional()
});

// AFTER (derived from Prisma - CORRECT)
import { UserSchema } from '@/domain/schemas/generated/schemas/models/User.schema';

export const UpdateUserSchema = UserSchema
  .pick({ firstName: true, lastName: true, dateOfBirth: true, timezone: true })
  .partial()
  .extend({
    // Override Date type with string for API
    dateOfBirth: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
  });
```

**Benefits:**
- Schema changes in Prisma automatically propagate to API
- TypeScript detects breaking changes
- No manual duplication = DRY principle

---

## References

- **bounded-contexts.md:** Lines 93-95, 122-124 (event-driven cross-context communication)
- **Story 1.11 (corrected):** commit 832c6c1
- **Story 1.9:** CreateBirthdayEventOnUserCreatedHandler implementation pattern
- **Story 1.10:** UserCreated event pattern
- **coding-standards.md:** Section 10 (Zod schemas), Prisma Zod Generator Integration
- **schema README:** src/domain/schemas/README.md

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-23 | 1.0 | Created refactoring story to fix bounded context violations from Story 1.11 implementation | Development Team |

---

## Estimated Effort

- Event Handlers: ~2 hours (3 handlers + tests)
- Use Case Refactoring: ~1 hour (remove logic, add event publishing)
- Schema Refactoring: ~30 minutes (derive from Prisma schemas)
- Test Updates: ~2 hours (update existing tests for event-driven architecture)
- Integration Testing: ~1 hour (verify end-to-end with event bus)

**Total: ~6.5 hours**
